<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

  <title>msgop(2) — Linux manual pages</title>
  <link rel="stylesheet" type="text/css" href="../stylesheet/manpages.css" />
  
  <link rel="home" href="../index.html" title="msgop(2) — Linux manual pages" />
  <script type="text/javascript" src="../stylesheet/manpages.js" xml:space="preserve">
</script>
  <link rel="icon" href="../stylesheet/icon.gif" type="image/gif" />
</head>

<body onload="javascript:init()">
  <div class="navheader">
    <table width="100%">
      <tbody>
        <tr>
          <td style="width: 33%" rowspan="1" colspan="1"><a href="../index.html" shape="rect">Linux
          manual pages</a></td>

          <th rowspan="1" colspan="1"><a href="../index2.html" shape="rect">Section 2</a></th>

          <td style="width: 33%" rowspan="1" colspan="1"> </td>
        </tr>
      </tbody>
    </table>
    <hr />
  </div>

  <div class="refentry">
    <a id="msgop.2" name="msgop.2" shape="rect"> </a>

    <div class="titlepage"> </div>

    <div class="refnamediv">
      <h2>Name</h2>

      <p>msgrcv, msgsnd — System V message queue
      operations</p>
    </div>

    <div class="refsynopsisdiv">
      <h2>Synopsis</h2>

      <div class="informalexample">
        <pre class="programlisting" xml:space="preserve">
#include &lt;sys/types.h&gt;
#include &lt;sys/ipc.h&gt;
#include &lt;sys/msg.h&gt;
</pre>
      </div>

      <div class="funcsynopsis">
        <table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;">
          <tr>
            <td rowspan="1" colspan="1"><code class="funcdef">int
            <strong>msgsnd</strong>(</code></td>

            <td rowspan="1" colspan="1">int <var class="pdparam">msqid</var>,</td>
          </tr>

          <tr>
            <td rowspan="1" colspan="1"> </td>

            <td rowspan="1" colspan="1">const void *<var class="pdparam">msgp</var>,</td>
          </tr>

          <tr>
            <td rowspan="1" colspan="1"> </td>

            <td rowspan="1" colspan="1">size_t <var class="pdparam">msgsz</var>,</td>
          </tr>

          <tr>
            <td rowspan="1" colspan="1"> </td>

            <td rowspan="1" colspan="1">int <var class="pdparam">msgflg</var><code>)</code>;</td>
          </tr>
        </table>

        <div class="funcprototype-spacer">
           
        </div>
      </div>

      <div class="funcsynopsis">
        <table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;">
          <tr>
            <td rowspan="1" colspan="1"><code class="funcdef">ssize_t
            <strong>msgrcv</strong>(</code></td>

            <td rowspan="1" colspan="1">int <var class="pdparam">msqid</var>,</td>
          </tr>

          <tr>
            <td rowspan="1" colspan="1"> </td>

            <td rowspan="1" colspan="1">void *<var class="pdparam">msgp</var>,</td>
          </tr>

          <tr>
            <td rowspan="1" colspan="1"> </td>

            <td rowspan="1" colspan="1">size_t <var class="pdparam">msgsz</var>,</td>
          </tr>

          <tr>
            <td rowspan="1" colspan="1"> </td>

            <td rowspan="1" colspan="1">long <var class="pdparam">msgtyp</var>,</td>
          </tr>

          <tr>
            <td rowspan="1" colspan="1"> </td>

            <td rowspan="1" colspan="1">int <var class="pdparam">msgflg</var><code>)</code>;</td>
          </tr>
        </table>

        <div class="funcprototype-spacer">
           
        </div>
      </div>
    </div>

    <div class="refsect1">
      <a id="msgop-2_sect1" name="msgop-2_sect1" shape="rect"> </a>

      <h2>DESCRIPTION</h2>

      <p>The <code class="function">msgsnd</code>() and
      <code class="function">msgrcv</code>() system calls are used,
      respectively, to send messages to, and receive messages from,
      a System V message queue. The calling process must have write
      permission on the message queue in order to send a message,
      and read permission to receive a message.</p>

      <p>The <em class="parameter"><code>msgp</code></em> argument
      is a pointer to a caller-defined structure of the following
      general form:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="structdef">
            <table style="border-collapse: collapse;">
              <colgroup span="1">
                <col class="c1" span="1" />
                <col class="c2" span="1" />
                <col class="c3" span="1" />
                <col class="c4" span="1" />
                <col class="c5" span="1" />
              </colgroup>

              <tbody>
                <tr>
                  <td class="structdefhdr" style="" align="left" rowspan="1" colspan="1">
                  struct</td>

                  <td class="structdefhdr" style="" colspan="4" align="left" rowspan="1"><span class="structname">msgbuf</span> {</td>
                </tr>

                <tr>
                  <td style="" rowspan="1" colspan="1"> </td>

                  <td style="" align="left" rowspan="1" colspan="1"><span class="type">long</span></td>

                  <td class="norightpad" style="" align="right" rowspan="1" colspan="1">
                   </td>

                  <td style="" align="left" rowspan="1" colspan="1"><em class="structfield"><code>mtype</code></em>;</td>

                  <td style="" align="left" rowspan="1" colspan="1">
                    <div class="literallayout">
                      
                      /* message type, must be &gt; 0 */
                    </div>
                  </td>
                </tr>

                <tr>
                  <td style="" rowspan="1" colspan="1"> </td>

                  <td style="" align="left" rowspan="1" colspan="1"><span class="type">char</span></td>

                  <td class="norightpad" style="" align="right" rowspan="1" colspan="1">
                   </td>

                  <td style="" align="left" rowspan="1" colspan="1"><em class="structfield"><code>mtext</code></em>[1];</td>

                  <td style="" align="left" rowspan="1" colspan="1">
                    <div class="literallayout">
                      /* message data */
                    </div>
                  </td>
                </tr>

                <tr>
                  <td class="structdefftr" style="" colspan="5" align="left" rowspan="1">};</td>
                </tr>
              </tbody>
            </table>
          </div>
        </blockquote>
      </div>

      <p>The <em class="parameter"><code>mtext</code></em> field is
      an array (or other structure) whose size is specified by
      <em class="parameter"><code>msgsz</code></em>, a nonnegative
      integer value. Messages of zero length (i.e., no <em class="parameter"><code>mtext</code></em> field) are permitted. The
      <em class="parameter"><code>mtype</code></em> field must have
      a strictly positive integer value. This value can be used by
      the receiving process for message selection (see the
      description of <code class="function">msgrcv</code>()
      below).</p>

      <div class="refsect2">
        <a id="msgop-2_sect2" name="msgop-2_sect2" shape="rect"> </a>

        <h3>msgsnd()</h3>

        <p>The <code class="function">msgsnd</code>() system call
        appends a copy of the message pointed to by <em class="parameter"><code>msgp</code></em> to the message queue
        whose identifier is specified by <em class="parameter"><code>msqid</code></em>.</p>

        <p>If sufficient space is available in the queue,
        <code class="function">msgsnd</code>() succeeds
        immediately. The queue capacity is governed by the
        <em class="replaceable"><code>msg_qbytes</code></em> field
        in the associated data structure for the message queue.
        During queue creation this field is initialized to
        <code class="constant">MSGMNB</code> bytes, but this limit
        can be modified using <a class="link" href="../htmlman2/msgctl.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">msgctl</span>(2)</span></a>. A message
        queue is considered to be full if either of the following
        conditions is true:</p>

        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc;">
            <li class="listitem">
              <p>Adding a new message to the queue would cause the
              total number of bytes in the queue to exceed the
              queue's maximum size (the <em class="replaceable"><code>msg_qbytes</code></em>
              field).</p>
            </li>

            <li class="listitem">
              <p>Adding another message to the queue would cause
              the total number of messages in the queue to exceed
              the queue's maximum size (the <em class="replaceable"><code>msg_qbytes</code></em> field).
              This check is necessary to prevent an unlimited
              number of zero-length messages being placed on the
              queue. Although such messages contain no data, they
              nevertheless consume (locked) kernel memory.</p>
            </li>
          </ul>
        </div>

        <p>If insufficient space is available in the queue, then
        the default behavior of <code class="function">msgsnd</code>() is to block until space becomes
        available. If <code class="constant">IPC_NOWAIT</code> is
        specified in <em class="parameter"><code>msgflg</code></em>, then the call instead
        fails with the error <span class="errorname">EAGAIN</span>.</p>

        <p>A blocked <code class="function">msgsnd</code>() call
        may also fail if:</p>

        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc;">
            <li class="listitem">
              <p>the queue is removed, in which case the system
              call fails with <code class="varname">errno</code>
              set to <span class="errorname">EIDRM</span>; or</p>
            </li>

            <li class="listitem">
              <p>a signal is caught, in which case the system call
              fails with <code class="varname">errno</code> set to
              <span class="errorname">EINTR</span>;<em class="replaceable"><code>see</code></em> <a class="link" href="../htmlman7/signal.7.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">signal</span>(7)</span></a>.
              (<code class="function">msgsnd</code>() is never
              automatically restarted after being interrupted by a
              signal handler, regardless of the setting of the
              <code class="constant">SA_RESTART</code> flag when
              establishing a signal handler.)</p>
            </li>
          </ul>
        </div>

        <p>Upon successful completion the message queue data
        structure is updated as follows:</p>

        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc;">
            <li class="listitem">
              <p><em class="replaceable"><code>msg_lspid</code></em> is set to
              the process ID of the calling process.</p>
            </li>

            <li class="listitem">
              <p><em class="replaceable"><code>msg_qnum</code></em>
              is incremented by 1.</p>
            </li>

            <li class="listitem">
              <p><em class="replaceable"><code>msg_stime</code></em> is set to
              the current time.</p>
            </li>
          </ul>
        </div>
      </div>

      <div class="refsect2">
        <a id="msgop-2_sect3" name="msgop-2_sect3" shape="rect"> </a>

        <h3>msgrcv()</h3>

        <p>The <code class="function">msgrcv</code>() system call
        removes a message from the queue specified by <em class="parameter"><code>msqid</code></em> and places it in the
        buffer pointed to by <em class="parameter"><code>msgp</code></em>.</p>

        <p>The argument <em class="parameter"><code>msgsz</code></em> specifies the maximum
        size in bytes for the member <em class="parameter"><code>mtext</code></em> of the structure
        pointed to by the <em class="parameter"><code>msgp</code></em> argument. If the message
        text has length greater than <em class="parameter"><code>msgsz</code></em>, then the behavior
        depends on whether <code class="constant">MSG_NOERROR</code> is specified in <em class="parameter"><code>msgflg</code></em>. If <code class="constant">MSG_NOERROR</code> is specified, then the
        message text will be truncated (and the truncated part will
        be lost); if <code class="constant">MSG_NOERROR</code> is
        not specified, then the message isn't removed from the
        queue and the system call fails returning −1 with
        <code class="varname">errno</code> set to <span class="errorname">E2BIG</span>.</p>

        <p>Unless <code class="constant">MSG_COPY</code> is
        specified in <em class="parameter"><code>msgflg</code></em>
        (see below), the <em class="parameter"><code>msgtyp</code></em> argument specifies the
        type of message requested, as follows:</p>

        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc;">
            <li class="listitem">
              <p>If <em class="parameter"><code>msgtyp</code></em>
              is 0, then the first message in the queue is
              read.</p>
            </li>

            <li class="listitem">
              <p>If <em class="parameter"><code>msgtyp</code></em>
              is greater than 0, then the first message in the
              queue of type <em class="parameter"><code>msgtyp</code></em> is read, unless
              <code class="constant">MSG_EXCEPT</code> was
              specified in <em class="parameter"><code>msgflg</code></em>, in which case
              the first message in the queue of type not equal to
              <em class="parameter"><code>msgtyp</code></em> will
              be read.</p>
            </li>

            <li class="listitem">
              <p>If <em class="parameter"><code>msgtyp</code></em>
              is less than 0, then the first message in the queue
              with the lowest type less than or equal to the
              absolute value of <em class="parameter"><code>msgtyp</code></em> will be
              read.</p>
            </li>
          </ul>
        </div>

        <p>The <em class="parameter"><code>msgflg</code></em>
        argument is a bit mask constructed by ORing together zero
        or more of the following flags:</p>

        <div class="variablelist">
          <dl class="variablelist">
            <dt><span class="term"><code class="constant">IPC_NOWAIT</code></span></dt>

            <dd>
              <p>Return immediately if no message of the requested
              type is in the queue. The system call fails with
              <code class="varname">errno</code> set to
              <span class="errorname">ENOMSG</span>.</p>
            </dd>

            <dt><span class="term"><code class="constant">MSG_COPY</code> (since Linux
            3.8)</span></dt>

            <dd>
              <p>Nondestructively fetch a copy of the message at
              the ordinal position in the queue specified by
              <em class="parameter"><code>msgtyp</code></em>
              (messages are considered to be numbered starting at
              0).</p>

              <p>This flag must be specified in conjunction with
              <code class="constant">IPC_NOWAIT</code>, with the
              result that, if there is no message available at the
              given position, the call fails immediately with the
              error <span class="errorname">ENOMSG</span>. Because
              they alter the meaning of <em class="parameter"><code>msgtyp</code></em> in orthogonal
              ways, <code class="constant">MSG_COPY</code> and
              <code class="constant">MSG_EXCEPT</code> may not both
              be specified in <em class="parameter"><code>msgflg</code></em>.</p>

              <p>The <code class="constant">MSG_COPY</code> flag
              was added for the implementation of the kernel
              checkpoint-restore facility and is available only if
              the kernel was built with the <code class="constant">CONFIG_CHECKPOINT_RESTORE</code>
              option.</p>
            </dd>

            <dt><span class="term"><code class="constant">MSG_EXCEPT</code></span></dt>

            <dd>
              <p>Used with <em class="parameter"><code>msgtyp</code></em> greater than 0
              to read the first message in the queue with message
              type that differs from <em class="parameter"><code>msgtyp</code></em>.</p>
            </dd>

            <dt><span class="term"><code class="constant">MSG_NOERROR</code></span></dt>

            <dd>
              <p>To truncate the message text if longer than
              <em class="parameter"><code>msgsz</code></em>
              bytes.</p>
            </dd>
          </dl>
        </div>

        <p>If no message of the requested type is available and
        <code class="constant">IPC_NOWAIT</code> isn't specified in
        <em class="parameter"><code>msgflg</code></em>, the calling
        process is blocked until one of the following conditions
        occurs:</p>

        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc;">
            <li class="listitem">
              <p>A message of the desired type is placed in the
              queue.</p>
            </li>

            <li class="listitem">
              <p>The message queue is removed from the system. In
              this case, the system call fails with <code class="varname">errno</code> set to <span class="errorname">EIDRM</span>.</p>
            </li>

            <li class="listitem">
              <p>The calling process catches a signal. In this
              case, the system call fails with <code class="varname">errno</code> set to <span class="errorname">EINTR</span>. (<code class="function">msgrcv</code>() is never automatically
              restarted after being interrupted by a signal
              handler, regardless of the setting of the
              <code class="constant">SA_RESTART</code> flag when
              establishing a signal handler.)</p>
            </li>
          </ul>
        </div>

        <p>Upon successful completion the message queue data
        structure is updated as follows:</p>

        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc;">
            <li class="listitem">
              <p><em class="replaceable"><code>msg_lrpid</code></em> is set to
              the process ID of the calling process.</p>
            </li>

            <li class="listitem">
              <p><em class="replaceable"><code>msg_qnum</code></em>
              is decremented by 1.</p>
            </li>

            <li class="listitem">
              <p><em class="replaceable"><code>msg_rtime</code></em> is set to
              the current time.</p>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="refsect1">
      <a id="msgop-2_sect4" name="msgop-2_sect4" shape="rect"> </a>

      <h2>RETURN VALUE</h2>

      <p>On failure both functions return −1 with
      <code class="varname">errno</code> indicating the error,
      otherwise <code class="function">msgsnd</code>() returns 0
      and <code class="function">msgrcv</code>() returns the number
      of bytes actually copied into the <em class="parameter"><code>mtext</code></em> array.</p>
    </div>

    <div class="refsect1">
      <a id="msgop-2_sect5" name="msgop-2_sect5" shape="rect"> </a>

      <h2>ERRORS</h2>

      <p>When <code class="function">msgsnd</code>() fails,
      <code class="varname">errno</code> will be set to one among
      the following values:</p>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><span class="errorname">EACCES</span></span></dt>

          <dd>
            <p>The calling process does not have write permission
            on the message queue, and does not have the
            <code class="constant">CAP_IPC_OWNER</code>
            capability.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EAGAIN</span></span></dt>

          <dd>
            <p>The message can't be sent due to the <em class="replaceable"><code>msg_qbytes</code></em> limit for
            the queue and <code class="constant">IPC_NOWAIT</code>
            was specified in <em class="parameter"><code>msgflg</code></em>.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EFAULT</span></span></dt>

          <dd>
            <p>The address pointed to by <em class="parameter"><code>msgp</code></em> isn't
            accessible.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EIDRM</span></span></dt>

          <dd>
            <p>The message queue was removed.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EINTR</span></span></dt>

          <dd>
            <p>Sleeping on a full message queue condition, the
            process caught a signal.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EINVAL</span></span></dt>

          <dd>
            <p>Invalid <em class="parameter"><code>msqid</code></em> value, or
            nonpositive <em class="parameter"><code>mtype</code></em> value, or invalid
            <em class="parameter"><code>msgsz</code></em> value
            (less than 0 or greater than the system value
            <code class="constant">MSGMAX</code>).</p>
          </dd>

          <dt><span class="term"><span class="errorname">ENOMEM</span></span></dt>

          <dd>
            <p>The system does not have enough memory to make a
            copy of the message pointed to by <em class="parameter"><code>msgp</code></em>.</p>
          </dd>
        </dl>
      </div>

      <p>When <code class="function">msgrcv</code>() fails,
      <code class="varname">errno</code> will be set to one among
      the following values:</p>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><span class="errorname">E2BIG</span></span></dt>

          <dd>
            <p>The message text length is greater than <em class="parameter"><code>msgsz</code></em> and <code class="constant">MSG_NOERROR</code> isn't specified in
            <em class="parameter"><code>msgflg</code></em>.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EACCES</span></span></dt>

          <dd>
            <p>The calling process does not have read permission on
            the message queue, and does not have the <code class="constant">CAP_IPC_OWNER</code> capability.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EFAULT</span></span></dt>

          <dd>
            <p>The address pointed to by <em class="parameter"><code>msgp</code></em> isn't
            accessible.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EIDRM</span></span></dt>

          <dd>
            <p>While the process was sleeping to receive a message,
            the message queue was removed.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EINTR</span></span></dt>

          <dd>
            <p>While the process was sleeping to receive a message,
            the process caught a signal; see <a class="link" href="../htmlman7/signal.7.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">signal</span>(7)</span></a>.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EINVAL</span></span></dt>

          <dd>
            <p><em class="replaceable"><code>msgqid</code></em> was
            invalid, or <em class="parameter"><code>msgsz</code></em> was less than
            0.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EINVAL</span> (since Linux 3.14)</span></dt>

          <dd>
            <p><em class="parameter"><code>msgflg</code></em>
            specified <code class="constant">MSG_COPY</code>, but
            not <code class="constant">IPC_NOWAIT</code>.</p>
          </dd>

          <dt><span class="term"><span class="errorname">EINVAL</span> (since Linux 3.14)</span></dt>

          <dd>
            <p><em class="parameter"><code>msgflg</code></em>
            specified both <code class="constant">MSG_COPY</code>
            and <code class="constant">MSG_EXCEPT</code>.</p>
          </dd>

          <dt><span class="term"><span class="errorname">ENOMSG</span></span></dt>

          <dd>
            <p><code class="constant">IPC_NOWAIT</code> was
            specified in <em class="parameter"><code>msgflg</code></em> and no message of
            the requested type existed on the message queue.</p>
          </dd>

          <dt><span class="term"><span class="errorname">ENOMSG</span></span></dt>

          <dd>
            <p><code class="constant">IPC_NOWAIT</code> and
            <code class="constant">MSG_COPY</code> were specified
            in <em class="parameter"><code>msgflg</code></em> and
            the queue contains less than <em class="parameter"><code>msgtyp</code></em> messages.</p>
          </dd>

          <dt><span class="term"><span class="errorname">ENOSYS</span> (since Linux 3.8)</span></dt>

          <dd>
            <p><code class="constant">MSG_COPY</code> was specified
            in <em class="parameter"><code>msgflg</code></em>, and
            this kernel was configured without <code class="constant">CONFIG_CHECKPOINT_RESTORE</code>.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="refsect1">
      <a id="msgop-2_sect6" name="msgop-2_sect6" shape="rect"> </a>

      <h2>CONFORMING TO</h2>

      <p>SVr4, POSIX.1-2001.</p>

      <p>The <code class="constant">MSG_EXCEPT</code> and
      <code class="constant">MSG_COPY</code> flags are
      Linux-specific; their definitions can be obtained by defining
      the <code class="constant">_GNU_SOURCE</code> feature test
      macro.</p>
    </div>

    <div class="refsect1">
      <a id="msgop-2_sect7" name="msgop-2_sect7" shape="rect"> </a>

      <h2>NOTES</h2>

      <p>The inclusion of <code class="literal">&lt;</code><code class="filename">sys/types.h</code><code class="literal">&gt;</code> and <code class="literal">&lt;</code><code class="filename">sys/ipc.h</code><code class="literal">&gt;</code>
      isn't required on Linux or by any version of POSIX. However,
      some old implementations required the inclusion of these
      header files, and the SVID also documented their inclusion.
      Applications intended to be portable to such old systems may
      need to include these header files.</p>

      <p>The <em class="parameter"><code>msgp</code></em> argument
      is declared as <span class="type">struct msgbuf *</span> in
      glibc 2.0 and 2.1. It is declared as <span class="emphasis"><em>void *</em></span> in glibc 2.2 and later, as
      required by SUSv2 and SUSv3.</p>

      <p>The following limits on message queue resources affect the
      <code class="function">msgsnd</code>() call:</p>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><code class="constant">MSGMAX</code></span></dt>

          <dd>
            <p>Maximum size of a message text, in bytes (default
            value: 8192 bytes). On Linux, this limit can be read
            and modified via <code class="filename">/proc/sys/kernel/msgmax</code>.</p>
          </dd>

          <dt><span class="term"><code class="constant">MSGMNB</code></span></dt>

          <dd>
            <p>Maximum number of bytes that can be held in a
            message queue (default value: 16384 bytes). On Linux,
            this limit can be read and modified via <code class="filename">/proc/sys/kernel/msgmnb</code>. A privileged
            process (Linux: a process with the <code class="constant">CAP_SYS_RESOURCE</code> capability) can
            increase the size of a message queue beyond
            <code class="constant">MSGMNB</code> using the
            <a class="link" href="../htmlman2/msgctl.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">msgctl</span>(2)</span></a>
            <code class="constant">IPC_SET</code> operation.</p>
          </dd>
        </dl>
      </div>

      <p>The implementation has no intrinsic system-wide limits on
      the number of message headers (<code class="constant">MSGTQL</code>) and the number of bytes in the
      message pool (<code class="constant">MSGPOOL</code>).</p>
    </div>

    <div class="refsect1">
      <a id="msgop-2_sect8" name="msgop-2_sect8" shape="rect"> </a>

      <h2>BUGS</h2>

      <p>In Linux 3.13 and earlier, if <code class="function">msgrcv</code>() was called with the <code class="constant">MSG_COPY</code> flag, but without <code class="constant">IPC_NOWAIT</code>, and the message queue contained
      less than <em class="parameter"><code>msgtyp</code></em>
      messages, then the call would block until the next message is
      written to the queue. At that point, the call would return a
      copy of the message, <em class="replaceable"><code>regardless</code></em> of whether that
      message was at the ordinal position <em class="parameter"><code>msgtyp</code></em>. This bug is fixed in
      Linux 3.14.</p>

      <p>Specifying both <code class="constant">MSG_COPY</code> and
      <code class="constant">MSC_EXCEPT</code> in <em class="parameter"><code>msgflg</code></em> is a logical error
      (since these flags impose different interpretations on
      <em class="parameter"><code>msgtyp</code></em>). In Linux
      3.13 and earlier, this error was not diagnosed by
      <code class="function">msgrcv</code>(). This bug is fixed in
      Linux 3.14.</p>
    </div>

    <div class="refsect1">
      <a id="msgop-2_sect9" name="msgop-2_sect9" shape="rect"> </a>

      <h2>EXAMPLE</h2>

      <p>The program below demonstrates the use of <code class="function">msgsnd</code>() and <code class="function">msgrcv</code>().</p>

      <p>The example program is first run with the <code class="option">−s</code> option to send a message and then
      run again with the <code class="option">−r</code>
      option to receive a message.</p>

      <p>The following shell session shows a sample run of the
      program:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
$<span class="emphasis"><em> ./a.out −s</em></span>
sent: a message at Wed Mar  4 16:25:45 2015

$<span class="emphasis"><em> ./a.out −r</em></span>
message received: a message at Wed Mar  4 16:25:45 2015
</pre>
          </div>
        </blockquote>
      </div>

      <div class="refsect2">
        <a id="msgop-2_sect10" name="msgop-2_sect10" shape="rect"> </a>

        <h3>Program source</h3>

        <div class="informalexample">
          <pre class="programlisting" xml:space="preserve">
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;time.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/ipc.h&gt;
#include &lt;sys/msg.h&gt;

struct msgbuf {
    long mtype;
    char mtext[80];
};

static void
usage(char *prog_name, char *msg)
{
    if (msg != NULL)
        fputs(msg, stderr);

    fprintf(stderr, "Usage: %s [options]\n", prog_name);
    fprintf(stderr, "Options are:\n");
    fprintf(stderr, "−s        send message using msgsnd()\n");
    fprintf(stderr, "−r        read message using msgrcv()\n");
    fprintf(stderr, "−t        message type (default is 1)\n");
    fprintf(stderr, "−k        message queue key (default is 1234)\n");
    exit(EXIT_FAILURE);
}

static void
send_msg(int qid, int msgtype)
{
    struct msgbuf msg;
    time_t t;

    msg.mtype = msgtype;

    time(&amp;t);
    snprintf(msg.mtext, sizeof(msg.mtext), "a message at %s",
            ctime(&amp;t));

    if (msgsnd(qid, (void *) &amp;msg, sizeof(msg.mtext),
                IPC_NOWAIT) == −1) {
        perror("msgsnd error");
        exit(EXIT_FAILURE);
    }
    printf("sent: %s\n", msg.mtext);
}

static void
get_msg(int qid, int msgtype)
{
    struct msgbuf msg;

    if (msgrcv(qid, (void *) &amp;msg, sizeof(msg.mtext), msgtype,
               MSG_NOERROR | IPC_NOWAIT) == −1) {
        if (errno != ENOMSG) {
            perror("msgrcv");
            exit(EXIT_FAILURE);
        }
        printf("No message available for msgrcv()\n");
    } else
        printf("message received: %s\n", msg.mtext);
}

int
main(int argc, char *argv[])
{
    int qid, opt;
    int mode = 0;               /* 1 = send, 2 = receive */
    int msgtype = 1;
    int msgkey = 1234;

    while ((opt = getopt(argc, argv, "srt:k:")) != −1) {
        switch (opt) {
        case 's':
            mode = 1;
            break;
        case 'r':
            mode = 2;
            break;
        case 't':
            msgtype = atoi(optarg);
            if (msgtype &lt;= 0)
                usage(argv[0], "−t option must be greater than 0\n");
            break;
        case 'k':
            msgkey = atoi(optarg);
            break;
        default:
            usage(argv[0], "Unrecognized option\n");
        }
    }

    if (mode == 0)
        usage(argv[0], "must use either −s or −r option\n");

    qid = msgget(msgkey, IPC_CREAT | 0666);

    if (qid == −1) {
        perror("msgget");
        exit(EXIT_FAILURE);
    }

    if (mode == 2)
        get_msg(qid, msgtype);
    else
        send_msg(qid, msgtype);

    exit(EXIT_SUCCESS);
}
</pre>
        </div>
      </div>
    </div>

    <div class="refsect1">
      <a id="msgop-2_sect11" name="msgop-2_sect11" shape="rect"> </a>

      <h2>SEE ALSO</h2>

      <p><a class="link" href="../htmlman2/msgctl.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">msgctl</span>(2)</span></a>, <a class="link" href="../htmlman2/msgget.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">msgget</span>(2)</span></a>, <a class="link" href="../htmlman7/capabilities.7.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">capabilities</span>(7)</span></a>, <a class="link" href="../htmlman7/mq_overview.7.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">mq_overview</span>(7)</span></a>, <a class="link" href="../htmlman7/svipc.7.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">svipc</span>(7)</span></a></p>
    </div>

    <div class="colophon">
      <a id="msgop-2_sect12" name="msgop-2_sect12" shape="rect"> </a>

      <h2>COLOPHON</h2>

      <p>This page is part of release 4.00 of the Linux <em class="replaceable"><code>man-pages</code></em> project. A
      description of the project, information about reporting bugs,
      and the latest version of this page, can be found at
      http://www.kernel.org/doc/man−pages/.</p>

      <div class="license">
        <table style="border-collapse: collapse;">
          <colgroup span="1">
            <col span="1" />
          </colgroup>

          <tbody>
            <tr>
              <td style="" rowspan="1" colspan="1">
                <div class="literallayout">
                  <br />
                    Copyright 1993 Giorgio Ciucci &lt;giorgio<script type="text/javascript">document.write('@');</script><noscript>(@)</noscript>crcc.it&gt;<br />

                  <br />
                  %%%LICENSE_START(VERBATIM)<br />
                  Permission is granted to make and distribute verbatim copies of this<br />

                  manual provided the copyright notice and this permission notice are<br />

                  preserved on all copies.<br />
                  <br />
                  Permission is granted to copy and distribute modified versions of this<br />

                  manual under the conditions for verbatim copying, provided that the<br />

                  entire resulting derived work is distributed under the terms of a<br />

                  permission notice identical to this one.<br />

                  <br />
                  Since the Linux kernel and libraries are constantly changing, this<br />

                  manual page may be incorrect or out-of-date.  The author(s) assume no<br />

                  responsibility for errors or omissions, or for damages resulting from<br />

                  the use of the information contained herein.  The author(s) may not<br />

                  have taken the same level of care in the production of this manual,<br />

                  which is licensed free of charge, as they might when working<br />

                  professionally.<br />
                  <br />
                  Formatted or processed versions of this manual, if unaccompanied by<br />

                  the source, must acknowledge the copyright and authors of this work.<br />

                  %%%LICENSE_END<br />
                  <br />
                  Modified Tue Oct 22 16:40:11 1996 by Eric S. Raymond &lt;esr<script type="text/javascript">document.write('@');</script><noscript>(@)</noscript>thyrsus.com&gt;<br />

                  Modified Mon Jul 10 21:09:59 2000 by aeb<br />

                  Modified 1 Jun 2002, Michael Kerrisk &lt;mtk.manpages<script type="text/javascript">document.write('@');</script><noscript>(@)</noscript>gmail.com&gt;<br />

                  Language clean-ups.<br />
                  Enhanced and corrected information on msg_qbytes, MSGMNB and MSGMAX<br />

                  Added note on restart behavior of msgsnd() and msgrcv()<br />

                  Formatting clean-ups (argument and field names marked as .I<br />

                  instead of .B)<br />
                  Modified, 27 May 2004, Michael Kerrisk &lt;mtk.manpages<script type="text/javascript">document.write('@');</script><noscript>(@)</noscript>gmail.com&gt;<br />

                      Added notes on capability requirements<br />

                  Modified, 11 Nov 2004, Michael Kerrisk &lt;mtk.manpages<script type="text/javascript">document.write('@');</script><noscript>(@)</noscript>gmail.com&gt;<br />

                  Language and formatting clean-ups<br />

                  Added notes on /proc files<br />
                  
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
