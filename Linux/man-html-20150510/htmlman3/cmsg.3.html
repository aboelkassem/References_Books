<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

  <title>cmsg(3) — Linux manual pages</title>
  <link rel="stylesheet" type="text/css" href="../stylesheet/manpages.css" />
  
  <link rel="home" href="../index.html" title="cmsg(3) — Linux manual pages" />
  <script type="text/javascript" src="../stylesheet/manpages.js" xml:space="preserve">
</script>
  <link rel="icon" href="../stylesheet/icon.gif" type="image/gif" />
</head>

<body onload="javascript:init()">
  <div class="navheader">
    <table width="100%">
      <tbody>
        <tr>
          <td style="width: 33%" rowspan="1" colspan="1"><a href="../index.html" shape="rect">Linux
          manual pages</a></td>

          <th rowspan="1" colspan="1"><a href="../index3.html" shape="rect">Section 3</a></th>

          <td style="width: 33%" rowspan="1" colspan="1"> </td>
        </tr>
      </tbody>
    </table>
    <hr />
  </div>

  <div class="refentry">
    <a id="cmsg.3" name="cmsg.3" shape="rect"> </a>

    <div class="titlepage"> </div>

    <div class="refnamediv">
      <h2>Name</h2>

      <p>CMSG_ALIGN, CMSG_SPACE, CMSG_NXTHDR, CMSG_FIRSTHDR —
      access ancillary data</p>
    </div>

    <div class="refsynopsisdiv">
      <h2>Synopsis</h2>

      <div class="funcsynopsis">
        <pre class="funcsynopsisinfo" xml:space="preserve">
#include &lt;sys/socket.h&gt;
</pre>

        <table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;">
          <tr>
            <td rowspan="1" colspan="1"><code class="funcdef">struct cmsghdr
            *<strong>CMSG_FIRSTHDR</strong>(</code></td>

            <td rowspan="1" colspan="1">struct msghdr *<var class="pdparam">msgh</var><code>)</code>;</td>
          </tr>
        </table>

        <div class="funcprototype-spacer">
           
        </div>
      </div>

      <div class="funcsynopsis">
        <table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;">
          <tr>
            <td rowspan="1" colspan="1"><code class="funcdef">struct cmsghdr
            *<strong>CMSG_NXTHDR</strong>(</code></td>

            <td rowspan="1" colspan="1">struct msghdr *<var class="pdparam">msgh</var>,</td>
          </tr>

          <tr>
            <td rowspan="1" colspan="1"> </td>

            <td rowspan="1" colspan="1">struct cmsghdr *<var class="pdparam">cmsg</var><code>)</code>;</td>
          </tr>
        </table>

        <div class="funcprototype-spacer">
           
        </div>
      </div>

      <div class="funcsynopsis">
        <table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;">
          <tr>
            <td rowspan="1" colspan="1"><code class="funcdef">size_t
            <strong>CMSG_ALIGN</strong>(</code></td>

            <td rowspan="1" colspan="1">size_t <var class="pdparam">length</var><code>)</code>;</td>
          </tr>
        </table>

        <div class="funcprototype-spacer">
           
        </div>
      </div>

      <div class="funcsynopsis">
        <table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;">
          <tr>
            <td rowspan="1" colspan="1"><code class="funcdef">size_t
            <strong>CMSG_SPACE</strong>(</code></td>

            <td rowspan="1" colspan="1">size_t <var class="pdparam">length</var><code>)</code>;</td>
          </tr>
        </table>

        <div class="funcprototype-spacer">
           
        </div>
      </div>

      <div class="funcsynopsis">
        <table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;">
          <tr>
            <td rowspan="1" colspan="1"><code class="funcdef">size_t
            <strong>CMSG_LEN</strong>(</code></td>

            <td rowspan="1" colspan="1">size_t <var class="pdparam">length</var><code>)</code>;</td>
          </tr>
        </table>

        <div class="funcprototype-spacer">
           
        </div>
      </div>

      <div class="funcsynopsis">
        <table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;">
          <tr>
            <td rowspan="1" colspan="1"><code class="funcdef">unsigned char
            *<strong>CMSG_DATA</strong>(</code></td>

            <td rowspan="1" colspan="1">struct cmsghdr *<var class="pdparam">cmsg</var><code>)</code>;</td>
          </tr>
        </table>

        <div class="funcprototype-spacer">
           
        </div>
      </div>

      <div class="structdef">
        <table style="border-collapse: collapse;">
          <colgroup span="1">
            <col class="c1" span="1" />
            <col class="c2" span="1" />
            <col class="c3" span="1" />
            <col class="c4" span="1" />
            <col class="c5" span="1" />
          </colgroup>

          <tbody>
            <tr>
              <td class="structdefhdr" style="" align="left" rowspan="1" colspan="1">
              struct</td>

              <td class="structdefhdr" style="" colspan="4" align="left" rowspan="1"><span class="structname">cmsghdr</span> {</td>
            </tr>

            <tr>
              <td style="" rowspan="1" colspan="1"> </td>

              <td style="" align="left" rowspan="1" colspan="1"><span class="type">socklen_t</span></td>

              <td class="norightpad" style="" align="right" rowspan="1" colspan="1">
               </td>

              <td style="" align="left" rowspan="1" colspan="1"><em class="structfield"><code>cmsg_len</code></em>;</td>

              <td style="" align="left" rowspan="1" colspan="1">
                <div class="literallayout">
                  
                  /* data byte count, including header */
                </div>
              </td>
            </tr>

            <tr>
              <td style="" rowspan="1" colspan="1"> </td>

              <td style="" align="left" rowspan="1" colspan="1"><span class="type">int</span></td>

              <td class="norightpad" style="" align="right" rowspan="1" colspan="1">
               </td>

              <td style="" align="left" rowspan="1" colspan="1"><em class="structfield"><code>cmsg_level</code></em>;</td>

              <td style="" align="left" rowspan="1" colspan="1">
                <div class="literallayout">
                  /* originating protocol */
                </div>
              </td>
            </tr>

            <tr>
              <td style="" rowspan="1" colspan="1"> </td>

              <td style="" align="left" rowspan="1" colspan="1"><span class="type">int</span></td>

              <td class="norightpad" style="" align="right" rowspan="1" colspan="1">
               </td>

              <td style="" align="left" rowspan="1" colspan="1"><em class="structfield"><code>cmsg_type</code></em>;</td>

              <td style="" align="left" rowspan="1" colspan="1">
                <div class="literallayout">
                  
                  /* protocol-specific type */
                </div>
              </td>
            </tr>

            <tr>
              <td style="" colspan="5" align="left" rowspan="1">
                <div class="literallayout">
                  
                  /* followed by unsigned char cmsg_data[]; */
                </div>
              </td>
            </tr>

            <tr>
              <td class="structdefftr" style="" colspan="5" align="left" rowspan="1">};</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="refsect1">
      <a id="cmsg-3_sect1" name="cmsg-3_sect1" shape="rect"> </a>

      <h2>DESCRIPTION</h2>

      <p>These macros are used to create and access control
      messages (also called ancillary data) that are not a part of
      the socket payload. This control information may include the
      interface the packet was received on, various rarely used
      header fields, an extended error description, a set of file
      descriptors or UNIX credentials. For instance, control
      messages can be used to send additional header fields such as
      IP options. Ancillary data is sent by calling <a class="link" href="../htmlman2/send.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">sendmsg</span>(2)</span></a> and received by
      calling <a class="link" href="../htmlman2/recv.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">recvmsg</span>(2)</span></a>. See their
      manual pages for more information.</p>

      <p>Ancillary data is a sequence of <span class="emphasis"><em>struct cmsghdr</em></span> structures with
      appended data. This sequence should be accessed using only
      the macros described in this manual page and never directly.
      See the specific protocol man pages for the available control
      message types. The maximum ancillary buffer size allowed per
      socket can be set using <code class="filename">/proc/sys/net/core/optmem_max</code>; see
      <a class="link" href="../htmlman7/socket.7.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">socket</span>(7)</span></a>.</p>

      <p><code class="function">CMSG_FIRSTHDR</code>() returns a
      pointer to the first <span class="structname">cmsghdr</span>
      in the ancillary data buffer associated with the passed
      <span class="structname">msghdr</span>.</p>

      <p><code class="function">CMSG_NXTHDR</code>() returns the
      next valid <span class="structname">cmsghdr</span> after the
      passed <span class="structname">cmsghdr</span>. It returns
      NULL when there isn't enough space left in the buffer.</p>

      <p><code class="function">CMSG_ALIGN</code>(), given a
      length, returns it including the required alignment. This is
      a constant expression.</p>

      <p><code class="function">CMSG_SPACE</code>() returns the
      number of bytes an ancillary element with payload of the
      passed data length occupies. This is a constant
      expression.</p>

      <p><code class="function">CMSG_DATA</code>() returns a
      pointer to the data portion of a <span class="structname">cmsghdr</span>.</p>

      <p><code class="function">CMSG_LEN</code>() returns the value
      to store in the <em class="parameter"><code>cmsg_len</code></em> member of the
      <span class="structname">cmsghdr</span> structure, taking
      into account any necessary alignment. It takes the data
      length as an argument. This is a constant expression.</p>

      <p>To create ancillary data, first initialize the
      <code class="varname">msg_controllen</code> member of the
      <span class="structname">msghdr</span> with the length of the
      control message buffer. Use <code class="function">CMSG_FIRSTHDR</code>() on the <span class="structname">msghdr</span> to get the first control message
      and <code class="function">CMSG_NXTHDR</code>() to get all
      subsequent ones. In each control message, initialize
      <em class="parameter"><code>cmsg_len</code></em> (with
      <code class="function">CMSG_LEN</code>()), the other
      <span class="structname">cmsghdr</span> header fields, and
      the data portion using <code class="function">CMSG_DATA</code>(). Finally, the <code class="varname">msg_controllen</code> field of the <span class="structname">msghdr</span> should be set to the sum of the
      <code class="function">CMSG_SPACE</code>() of the length of
      all control messages in the buffer. For more information on
      the <span class="structname">msghdr</span>, see <a class="link" href="../htmlman2/recv.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">recvmsg</span>(2)</span></a>.</p>

      <p>When the control message buffer is too short to store all
      messages, the <code class="constant">MSG_CTRUNC</code> flag
      is set in the <code class="varname">msg_flags</code> member
      of the <span class="structname">msghdr</span>.</p>
    </div>

    <div class="refsect1">
      <a id="cmsg-3_sect2" name="cmsg-3_sect2" shape="rect"> </a>

      <h2>CONFORMING TO</h2>

      <p>This ancillary data model conforms to the POSIX.1g draft,
      4.4BSD-Lite, the IPv6 advanced API described in RFC 2292 and
      SUSv2. <code class="function">CMSG_ALIGN</code>() is a Linux
      extension.</p>
    </div>

    <div class="refsect1">
      <a id="cmsg-3_sect3" name="cmsg-3_sect3" shape="rect"> </a>

      <h2>NOTES</h2>

      <p>For portability, ancillary data should be accessed using
      only the macros described here. <code class="function">CMSG_ALIGN</code>() is a Linux extension and
      should not be used in portable programs.</p>

      <p>In Linux, <code class="function">CMSG_LEN</code>(),
      <code class="function">CMSG_DATA</code>(), and <code class="function">CMSG_ALIGN</code>() are constant expressions
      (assuming their argument is constant); this could be used to
      declare the size of global variables. This may not be
      portable, however.</p>
    </div>

    <div class="refsect1">
      <a id="cmsg-3_sect4" name="cmsg-3_sect4" shape="rect"> </a>

      <h2>EXAMPLE</h2>

      <p>This code looks for the <code class="constant">IP_TTL</code> option in a received ancillary
      buffer:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
struct msghdr msgh;
struct cmsghdr *cmsg;
int *ttlptr;
int received_ttl;

/* Receive auxiliary data in msgh */
for (cmsg = CMSG_FIRSTHDR(&amp;msgh); cmsg != NULL;
        cmsg = CMSG_NXTHDR(&amp;msgh,cmsg)) {
    if (cmsg−&gt;cmsg_level == IPPROTO_IP
            &amp;&amp; cmsg−&gt;cmsg_type == IP_TTL) {
        ttlptr = (int *) CMSG_DATA(cmsg);
        received_ttl = *ttlptr;
        break;
    }
}
if (cmsg == NULL) {
    /*
     * Error: IP_TTL not enabled or small buffer
     * or I/O error.
     */
}
</pre>
          </div>
        </blockquote>
      </div>

      <p>The code below passes an array of file descriptors over a
      UNIX domain socket using <code class="constant">SCM_RIGHTS</code>:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
struct msghdr msg = {0};
struct cmsghdr *cmsg;
int myfds[NUM_FD]; /* Contains the file descriptors to pass. */
union {
    /* ancillary data buffer, wrapped in a union in order to ensure
       it is suitably aligned */
    char buf[CMSG_SPACE(sizeof myfds)];
    struct cmsghdr align;
} u;
int *fdptr;

msg.msg_control = u.buf;
msg.msg_controllen = sizeof u.buf;
cmsg = CMSG_FIRSTHDR(&amp;msg);
cmsg−&gt;cmsg_level = SOL_SOCKET;
cmsg−&gt;cmsg_type = SCM_RIGHTS;
cmsg−&gt;cmsg_len = CMSG_LEN(sizeof(int) * NUM_FD);
/* Initialize the payload: */
fdptr = (int *) CMSG_DATA(cmsg);
memcpy(fdptr, myfds, NUM_FD * sizeof(int));
</pre>
          </div>
        </blockquote>
      </div>
    </div>

    <div class="refsect1">
      <a id="cmsg-3_sect5" name="cmsg-3_sect5" shape="rect"> </a>

      <h2>SEE ALSO</h2>

      <p><a class="link" href="../htmlman2/recv.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">recvmsg</span>(2)</span></a>, <a class="link" href="../htmlman2/send.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">sendmsg</span>(2)</span></a></p>

      <p>RFC 2292</p>
    </div>

    <div class="colophon">
      <a id="cmsg-3_sect6" name="cmsg-3_sect6" shape="rect"> </a>

      <h2>COLOPHON</h2>

      <p>This page is part of release 4.00 of the Linux <em class="replaceable"><code>man-pages</code></em> project. A
      description of the project, information about reporting bugs,
      and the latest version of this page, can be found at
      http://www.kernel.org/doc/man−pages/.</p>

      <div class="license">
        <table style="border-collapse: collapse;">
          <colgroup span="1">
            <col span="1" />
          </colgroup>

          <tbody>
            <tr>
              <td style="" rowspan="1" colspan="1">
                <div class="literallayout">
                  <br />
                    This man page is Copyright (C) 1999 Andi Kleen &lt;ak<script type="text/javascript">document.write('@');</script><noscript>(@)</noscript>muc.de&gt;.<br />

                  <br />
                  %%%LICENSE_START(VERBATIM_ONE_PARA)<br />
                  Permission is granted to distribute possibly modified copies<br />

                  of this page provided the header is included verbatim,<br />

                  and in case of nontrivial modification author and date<br />

                  of the modification is added to the header.<br />

                  %%%LICENSE_END<br />
                  <br />
                  $Id: cmsg.3,v 1.8 2000/12/20 18:10:31 ak Exp $<br />
                  
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
