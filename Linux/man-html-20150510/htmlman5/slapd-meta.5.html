<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

  <title>slapd-meta(5) — Linux manual pages</title>
  <link rel="stylesheet" type="text/css" href="../stylesheet/manpages.css" />
  
  <link rel="home" href="../index.html" title="slapd-meta(5) — Linux manual pages" />
  <script type="text/javascript" src="../stylesheet/manpages.js" xml:space="preserve">
</script>
  <link rel="icon" href="../stylesheet/icon.gif" type="image/gif" />
</head>

<body onload="javascript:init()">
  <div class="navheader">
    <table width="100%">
      <tbody>
        <tr>
          <td style="width: 33%" rowspan="1" colspan="1"><a href="../index.html" shape="rect">Linux
          manual pages</a></td>

          <th rowspan="1" colspan="1"><a href="../index5.html" shape="rect">Section 5</a></th>

          <td style="width: 33%" rowspan="1" colspan="1"> </td>
        </tr>
      </tbody>
    </table>
    <hr />
  </div>

  <div class="refentry">
    <a id="slapd-meta.5" name="slapd-meta.5" shape="rect"> </a>

    <div class="titlepage"> </div>

    <div class="refnamediv">
      <h2>Name</h2>

      <p>slapd−meta — metadirectory backend to
      slapd</p>
    </div>

    <div class="refsynopsisdiv">
      <h2>Synopsis</h2>

      <div class="informalexample">
        <pre class="programlisting" xml:space="preserve">
ETCDIR/slapd.conf
  
</pre>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect1" name="slapd-meta-5_sect1" shape="rect"> </a>

      <h2>DESCRIPTION</h2>

      <p>The <em class="replaceable"><code>meta</code></em> backend
      to <a class="link" href="../htmlman8/slapd.8.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd</span>(8)</span></a> performs basic
      LDAP proxying with respect to a set of remote LDAP servers,
      called "targets". The information contained in these servers
      can be presented as belonging to a single Directory
      Information Tree (DIT).</p>

      <p>A basic knowledge of the functionality of the <a class="link" href="../htmlman5/slapd-ldap.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd-ldap</span>(5)</span></a> backend is
      recommended. This backend has been designed as an enhancement
      of the ldap backend. The two backends share many features
      (actually they also share portions of code). While the
      <em class="citetitle">ldap</em> backend is intended to proxy
      operations directed to a single server, the <em class="replaceable"><code>meta</code></em> backend is mainly
      intended for proxying of multiple servers and possibly naming
      context masquerading. These features, although useful in many
      scenarios, may result in excessive overhead for some
      applications, so its use should be carefully considered. In
      the examples section, some typical scenarios will be
      discussed.</p>

      <p>The proxy instance of <a class="link" href="../htmlman8/slapd.8.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd</span>(8)</span></a> must contain
      schema information for the attributes and objectClasses used
      in filters, request DN and request-related data in general.
      It should also contain schema information for the data
      returned by the proxied server. It is the responsibility of
      the proxy administrator to keep the schema of the proxy lined
      up with that of the proxied server.</p>

      <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
        <table border="0" summary="Note">
          <tr>
            <td rowspan="2" align="center" valign="top" width="25" colspan="1">
            <img alt="[Note]" src="../stylesheet/note.png" /></td>

            <th align="left" rowspan="1" colspan="1">Note</th>
          </tr>

          <tr>
            <td align="left" valign="top" rowspan="1" colspan="1">
              <p>When looping back to the same instance of
              <a class="link" href="../htmlman8/slapd.8.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd</span>(8)</span></a>, each
              connection requires a new thread; as a consequence,
              <a class="link" href="../htmlman8/slapd.8.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd</span>(8)</span></a> must be
              compiled with thread support, and the <em class="replaceable"><code>threads</code></em> parameter may
              need some tuning; in those cases, unless the multiple
              target feature is required, one may consider using
              <a class="link" href="../htmlman5/slapd-relay.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd-relay</span>(5)</span></a>
              instead, which performs the relayed operation
              internally and thus reuses the same connection.</p>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect2" name="slapd-meta-5_sect2" shape="rect"> </a>

      <h2>EXAMPLES</h2>

      <p>There are examples in various places in this document, as
      well as in the slapd/back−meta/data/ directory in the
      OpenLDAP source tree.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect3" name="slapd-meta-5_sect3" shape="rect"> </a>

      <h2>CONFIGURATION</h2>

      <p>These <em class="replaceable"><code>slapd.conf</code></em>
      options apply to the META backend database. That is, they
      must follow a "database meta" line and come before any
      subsequent "backend" or "database" lines. Other database
      options are described in the <a class="link" href="../htmlman5/slapd.conf.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd.conf</span>(5)</span></a> manual
      page.</p>

      <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
        <table border="0" summary="Note">
          <tr>
            <td rowspan="2" align="center" valign="top" width="25" colspan="1">
            <img alt="[Note]" src="../stylesheet/note.png" /></td>

            <th align="left" rowspan="1" colspan="1">Note</th>
          </tr>

          <tr>
            <td align="left" valign="top" rowspan="1" colspan="1">
              <p>In early versions of back-ldap and back-meta it
              was recommended to always set</p>
            </td>
          </tr>
        </table>
      </div>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
lastmod  off
</pre>
          </div>
        </blockquote>
      </div>

      <p>for <em class="citetitle">ldap</em> and <em class="replaceable"><code>meta</code></em> databases. This was
      required because operational attributes related to entry
      creation and modification should not be proxied, as they
      could be mistakenly written to the target server(s),
      generating an error. The current implementation automatically
      sets lastmod to <em class="replaceable"><code>off</code></em>, so its use is redundant
      and should be omitted.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect4" name="slapd-meta-5_sect4" shape="rect"> </a>

      <h2>SPECIAL CONFIGURATION DIRECTIVES</h2>

      <p>Target configuration starts with the "uri" directive. All
      the configuration directives that are not specific to targets
      should be defined first for clarity, including those that are
      common to all backends. They are:</p>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><span class="emphasis"><em>conn−ttl
          &lt;time&gt;</em></span></span></dt>

          <dd>
            <p>This directive causes a cached connection to be
            dropped an recreated after a given ttl, regardless of
            being idle or not.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>default−target
          none</em></span></span></dt>

          <dd>
            <p>This directive forces the backend to reject all
            those operations that must resolve to a single target
            in case none or multiple targets are selected. They
            include: add, delete, modify, modrdn; compare is not
            included, as well as bind since, as they don't alter
            entries, in case of multiple matches an attempt is made
            to perform the operation on any candidate target, with
            the constraint that at most one must succeed. This
            directive can also be used when processing targets to
            mark a specific target as default.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>dncache−ttl
          {DISABLED|forever|&lt;ttl&gt;}</em></span></span></dt>

          <dd>
            <p>This directive sets the time-to-live of the DN
            cache. This caches the target that holds a given DN to
            speed up target selection in case multiple targets
            would result from an uncached search; forever means
            cache never expires; disabled means no DN caching;
            otherwise a valid ( &gt; 0 ) ttl is required, in the
            format illustrated for the <em class="replaceable"><code>idle−timeout</code></em>
            directive.</p>
          </dd>

          <dt><span class="term">nerr
          {CONTINUE|report|stop}</span></dt>

          <dd>
            <p>This directive allows to select the behavior in case
            an error is returned by one target during a search. The
            default, <em class="replaceable"><code>continue</code></em>, consists in
            continuing the operation, trying to return as much data
            as possible. If the value is set to <em class="replaceable"><code>stop</code></em>, the search is
            terminated as soon as an error is returned by one
            target, and the error is immediately propagated to the
            client. If the value is set to <em class="replaceable"><code>report</code></em>, the search is
            continuated to the end but, in case at least one target
            returned an error code, the first non-success error
            code is returned.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>norefs
          &lt;NO|yes&gt;</em></span></span></dt>

          <dd>
            <p>If <em class="replaceable"><code>yes</code></em>, do
            not return search reference responses. By default, they
            are returned unless request is LDAPv2. If set before
            any target specification, it affects all targets,
            unless overridden by any per-target directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>noundeffilter
          &lt;NO|yes&gt;</em></span></span></dt>

          <dd>
            <p>If <em class="replaceable"><code>yes</code></em>,
            return success instead of searching if a filter is
            undefined or contains undefined portions. By default,
            the search is propagated after replacing undefined
            portions with <em class="replaceable"><code>(!(objectClass=*))</code></em>,
            which corresponds to the empty result set. If set
            before any target specification, it affects all
            targets, unless overridden by any per-target
            directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>protocol−version
          {0,2,3}</em></span></span></dt>

          <dd>
            <p>This directive indicates what protocol version must
            be used to contact the remote server. If set to 0 (the
            default), the proxy uses the same protocol version used
            by the client, otherwise the requested protocol is
            used. The proxy returns <em class="replaceable"><code>unwillingToPerform</code></em> if
            an operation that is incompatible with the requested
            protocol is attempted. If set before any target
            specification, it affects all targets, unless
            overridden by any per-target directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>pseudoroot−bind−defer
          {YES|no}</em></span></span></dt>

          <dd>
            <p>This directive, when set to <em class="replaceable"><code>yes</code></em>, causes the
            authentication to the remote servers with the
            pseudo-root identity (the identity defined in each
            <em class="replaceable"><code>idassert-bind</code></em>
            directive) to be deferred until actually needed by
            subsequent operations. Otherwise, all binds as the
            rootdn are propagated to the targets.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>quarantine
          &lt;interval&gt;,&lt;num&gt;[;&lt;interval&gt;,&lt;num&gt;[...]]</em></span></span></dt>

          <dd>
            <p>Turns on quarantine of URIs that returned
            <span class="errorname">LDAP_UNAVAILABLE</span>, so
            that an attempt to reconnect only occurs at given
            intervals instead of any time a client requests an
            operation. The pattern is: retry only after at least
            <em class="replaceable"><code>interval</code></em>
            seconds elapsed since last attempt, for exactly
            <em class="replaceable"><code>num</code></em> times;
            then use the next pattern. If <em class="replaceable"><code>num</code></em> for the last
            pattern is "<code class="literal">+</code>", it retries
            forever; otherwise, no more retries occur. This
            directive must appear before any target specification;
            it affects all targets with the same pattern.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>rebind−as−user
          {NO|yes}</em></span></span></dt>

          <dd>
            <p>If this option is given, the client's bind
            credentials are remembered for rebinds, when trying to
            re-establish a broken connection, or when chasing a
            referral, if <em class="replaceable"><code>chase−referrals</code></em>
            is set to <em class="replaceable"><code>yes</code></em>.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>session−tracking−request
          {NO|yes}</em></span></span></dt>

          <dd>
            <p>Adds session tracking control for all requests. The
            client's IP and hostname, and the identity associated
            to each request, if known, are sent to the remote
            server for informational purposes. This directive is
            incompatible with setting <em class="replaceable"><code>protocol−version</code></em>
            to 2. If set before any target specification, it
            affects all targets, unless overridden by any
            per-target directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>single−conn
          {NO|yes}</em></span></span></dt>

          <dd>
            <p>Discards current cached connection when the client
            rebinds.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>use−temporary−conn
          {NO|yes}</em></span></span></dt>

          <dd>
            <p>when set to <em class="replaceable"><code>yes</code></em>, create a temporary
            connection whenever competing with other threads for a
            shared one; otherwise, wait until the shared connection
            is available.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect5" name="slapd-meta-5_sect5" shape="rect"> </a>

      <h2>TARGET SPECIFICATION</h2>

      <p>Target specification starts with a "uri" directive:</p>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><span class="emphasis"><em>uri
          &lt;protocol&gt;://[&lt;host&gt;]/&lt;naming context&gt;
          [...]</em></span></span></dt>

          <dd>
            <p>The &lt;protocol&gt; part can be anything <a class="link" href="../htmlman3/ldap_open.3.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">ldap_initialize</span>(3)</span></a>
            accepts ({ldap|ldaps|ldapi} and variants); the
            &lt;host&gt; may be omitted, defaulting to whatever is
            set in <a class="link" href="../htmlman5/ldap.conf.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">ldap.conf</span>(5)</span></a>. The
            &lt;naming context&gt; part is <em class="replaceable"><code>mandatory</code></em> for the first
            URI, but it <span class="emphasis"><em>must be
            omitted</em></span> for subsequent ones, if any. The
            naming context part must be within the naming context
            defined for the backend, e.g.:</p>
          </dd>
        </dl>
      </div>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
suffix "<em class="replaceable"><code>dc=foo,dc=com</code></em>"
uri    "ldap://x.foo.com/dc=x,<em class="replaceable"><code>dc=foo,dc=com</code></em>"
</pre>
          </div>
        </blockquote>
      </div>

      <div class="blockquote">
        <blockquote class="blockquote">
          <p>The &lt;naming context&gt; part doesn't need to be
          unique across the targets; it may also match one of the
          values of the "suffix" directive. Multiple URIs may be
          defined in a single URI statement. The additional URIs
          must be separate arguments and must not have any
          &lt;naming context&gt; part. This causes the underlying
          library to contact the first server of the list that
          responds. For example, if <em class="replaceable"><code>l1.foo.com</code></em> and <em class="replaceable"><code>l2.foo.com</code></em> are shadows of
          the same server, the directive</p>

          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
suffix "<em class="replaceable"><code>dc=foo,dc=com</code></em>"
uri    "ldap://l1.foo.com/<em class="replaceable"><code>dc=foo,dc=com</code></em>" "ldap://l2.foo.com/"
</pre>
          </div>
        </blockquote>
      </div>

      <div class="blockquote">
        <blockquote class="blockquote">
          <p>causes <em class="replaceable"><code>l2.foo.com</code></em> to be
          contacted whenever <em class="replaceable"><code>l1.foo.com</code></em> does not
          respond. In that case, the URI list is internally
          rearranged, by moving unavailable URIs to the end, so
          that further connection attempts occur with respect to
          the last URI that succeeded.</p>
        </blockquote>
      </div>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><span class="emphasis"><em>acl−authcDN &lt;administrative DN
          for access control purposes&gt;</em></span></span></dt>

          <dd>
            <p>DN which is used to query the target server for acl
            checking, as in the LDAP backend; it is supposed to
            have read access on the target server to attributes
            used on the proxy for acl checking. There is no risk of
            giving away such values; they are only used to check
            permissions. <span class="emphasis"><em>The
            acl−authcDN identity is by no means implicitly
            used by the proxy</em></span> <span class="emphasis"><em>when the client connects
            anonymously.</em></span></p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>acl−passwd
          &lt;password&gt;</em></span></span></dt>

          <dd>
            <p>Password used with the <em class="replaceable"><code>acl−authcDN</code></em>
            above.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>bind−timeout
          &lt;microseconds&gt;</em></span></span></dt>

          <dd>
            <p>This directive defines the timeout, in microseconds,
            used when polling for response after an asynchronous
            bind connection. The initial call to ldap_result(3) is
            performed with a trade-off timeout of 100000 us; if
            that results in a timeout exceeded, subsequent calls
            use the value provided with <em class="replaceable"><code>bind−timeout</code></em>. The
            default value is used also for subsequent calls if
            <em class="replaceable"><code>bind−timeout</code></em> is
            not specified. If set before any target specification,
            it affects all targets, unless overridden by any
            per-target directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>chase−referrals
          {YES|no}</em></span></span></dt>

          <dd>
            <p>enable/disable automatic referral chasing, which is
            delegated to the underlying libldap, with rebinding
            eventually performed if the <em class="replaceable"><code>rebind−as−user</code></em>
            directive is used. The default is to chase referrals.
            If set before any target specification, it affects all
            targets, unless overridden by any per-target
            directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>client−pr
          {accept-unsolicited|DISABLE|&lt;size&gt;}</em></span></span></dt>

          <dd>
            <p>This feature allows to use RFC 2696 Paged Results
            control when performing search operations with a
            specific target, irrespective of the client's request.
            When set to a numeric value, Paged Results control is
            always used with <em class="replaceable"><code>size</code></em> as the page size.
            When set to <em class="replaceable"><code>accept-unsolicited</code></em>,
            unsolicited Paged Results control responses are
            accepted and honored for compatibility with broken
            remote DSAs. The client is not exposed to paged results
            handling between <a class="link" href="../htmlman5/slapd-meta.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd-meta</span>(5)</span></a> and the
            remote servers. By default (disabled), Paged Results
            control is not used and responses are not accepted. If
            set before any target specification, it affects all
            targets, unless overridden by any per-target
            directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>default−target
          [&lt;target&gt;]</em></span></span></dt>

          <dd>
            <p>The "default−target" directive can also be
            used during target specification. With no arguments it
            marks the current target as the default. The optional
            number marks target &lt;target&gt; as the default one,
            starting from 1. Target &lt;target&gt; must be
            defined.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>filter
          &lt;pattern&gt;</em></span></span></dt>

          <dd>
            <p>This directive allows specifying a <span class="citerefentry"><span class="refentrytitle">regex</span>(5)</span> pattern to
            indicate what search filter terms are actually served
            by a target.</p>

            <p>In a search request, if the search filter matches
            the <em class="replaceable"><code>pattern</code></em>
            the target is considered while fulfilling the request;
            otherwise the target is ignored. There may be multiple
            occurrences of the <em class="replaceable"><code>filter</code></em> directive for
            each target.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>idassert−authzFrom
          &lt;authz-regexp&gt;</em></span></span></dt>

          <dd>
            <p>if defined, selects what <em class="replaceable"><code>local</code></em> identities are
            authorized to exploit the identity assertion feature.
            The string <em class="replaceable"><code>&lt;authz-regexp&gt;</code></em>
            follows the rules defined for the <em class="replaceable"><code>authzFrom</code></em> attribute.
            See <a class="link" href="../htmlman5/slapd.conf.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd.conf</span>(5)</span></a>,
            section related to <em class="replaceable"><code>authz−policy</code></em>, for
            details on the syntax of this field.</p>

            <p><em class="replaceable"><code>idassert−bind</code></em>
            <span class="emphasis"><em>bindmethod=none|simple|sasl
            [binddn=&lt;simple DN&gt;] [credentials=&lt;simple
            password&gt;]</em></span> <span class="emphasis"><em>[saslmech=&lt;SASL mech&gt;]
            [secprops=&lt;properties&gt;]
            [realm=&lt;realm&gt;]</em></span> <span class="emphasis"><em>[authcId=&lt;authentication ID&gt;]
            [authzId=&lt;authorization ID&gt;]</em></span>
            <span class="emphasis"><em>[authz={native|proxyauthz}]
            [mode=&lt;mode&gt;] [flags=&lt;flags&gt;]</em></span>
            <em class="replaceable"><code>[starttls=no|yes|critical]</code></em>
            <em class="replaceable"><code>[tls_cert=&lt;file&gt;]</code></em>
            <em class="replaceable"><code>[tls_key=&lt;file&gt;]</code></em>
            <em class="replaceable"><code>[tls_cacert=&lt;file&gt;]</code></em>
            <em class="replaceable"><code>[tls_cacertdir=&lt;path&gt;]</code></em>
            <em class="replaceable"><code>[tls_reqcert=never|allow|try|demand]</code></em>
            <em class="replaceable"><code>[tls_ciphersuite=&lt;ciphers&gt;]</code></em>
            <em class="replaceable"><code>[tls_protocol_min=&lt;major&gt;[.&lt;minor&gt;]]</code></em>
            <em class="replaceable"><code>[tls_crlcheck=none|peer|all]</code></em></p>

            <div class="blockquote">
              <blockquote class="blockquote">
                <p>Allows to define the parameters of the
                authentication method that is internally used by
                the proxy to authorize connections that are
                authenticated by other databases. The identity
                defined by this directive, according to the
                properties associated to the authentication method,
                is supposed to have auth access on the target
                server to attributes used on the proxy for
                authentication and authorization, and to be allowed
                to authorize the users. This requires to have
                <em class="replaceable"><code>proxyAuthz</code></em>
                privileges on a wide set of DNs, e.g. <em class="replaceable"><code>authzTo=dn.subtree:""</code></em>,
                and the remote server to have <em class="replaceable"><code>authz−policy</code></em>
                set to <em class="replaceable"><code>to</code></em>
                or <em class="replaceable"><code>both</code></em>.
                See <a class="link" href="../htmlman5/slapd.conf.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd.conf</span>(5)</span></a> for
                details on these statements and for remarks and
                drawbacks about their usage. The supported
                bindmethods are</p>

                <p><em class="replaceable"><code>none|simple|sasl</code></em></p>

                <p>where <em class="replaceable"><code>none</code></em> is the
                default, i.e. no <span class="emphasis"><em>identity assertion</em></span> is
                performed.</p>

                <p>The authz parameter is used to instruct the SASL
                bind to exploit <em class="replaceable"><code>native</code></em> SASL
                authorization, if available; since connections are
                cached, this should only be used when authorizing
                with a fixed identity (e.g. by means of the
                <em class="replaceable"><code>authzDN</code></em>
                or <em class="replaceable"><code>authzID</code></em>
                parameters). Otherwise, the default <em class="replaceable"><code>proxyauthz</code></em> is used,
                i.e. the proxyAuthz control (Proxied Authorization,
                RFC 4370) is added to all operations.</p>

                <p>The supported modes are:</p>

                <p><span class="emphasis"><em>&lt;mode&gt; :=
                {legacy|anonymous|none|self}</em></span></p>

                <p>If <em class="replaceable"><code>&lt;mode&gt;</code></em> is not
                present, and <em class="replaceable"><code>authzId</code></em> is given,
                the proxy always authorizes that identity.
                <span class="emphasis"><em>&lt;authorization
                ID&gt;</em></span> can be</p>

                <p><em class="replaceable"><code>u:&lt;user&gt;</code></em></p>

                <p><em class="replaceable"><code>[dn:]&lt;DN&gt;</code></em></p>

                <p>The former is supposed to be expanded by the
                remote server according to the authz rules; see
                <a class="link" href="../htmlman5/slapd.conf.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd.conf</span>(5)</span></a> for
                details. In the latter case, whether or not the
                <em class="replaceable"><code>dn:</code></em>
                prefix is present, the string must pass DN
                validation and normalization.</p>

                <p>The default mode is <em class="replaceable"><code>legacy</code></em>, which
                implies that the proxy will either perform a simple
                bind as the <em class="replaceable"><code>authcDN</code></em> or a SASL
                bind as the <em class="replaceable"><code>authcID</code></em> and assert
                the client's identity when it is not anonymous.
                Direct binds are always proxied. The other modes
                imply that the proxy will always either perform a
                simple bind as the <em class="replaceable"><code>authcDN</code></em> or a SASL
                bind as the <em class="replaceable"><code>authcID</code></em>, unless
                restricted by <em class="replaceable"><code>idassert−authzFrom</code></em>
                rules (see below), in which case the operation will
                fail; eventually, it will assert some other
                identity according to <em class="replaceable"><code>&lt;mode&gt;</code></em>. Other
                identity assertion modes are <em class="replaceable"><code>anonymous</code></em> and
                <em class="replaceable"><code>self</code></em>,
                which respectively mean that the <em class="replaceable"><code>empty</code></em> or the
                <em class="replaceable"><code>client</code></em>'s
                identity will be asserted; <em class="replaceable"><code>none</code></em>, which means
                that no proxyAuthz control will be used, so the
                <em class="replaceable"><code>authcDN</code></em>
                or the <em class="replaceable"><code>authcID</code></em> identity
                will be asserted. For all modes that require the
                use of the <em class="replaceable"><code>proxyAuthz</code></em> control,
                on the remote server the proxy identity must have
                appropriate <em class="replaceable"><code>authzTo</code></em>
                permissions, or the asserted identities must have
                appropriate <em class="replaceable"><code>authzFrom</code></em>
                permissions. Note, however, that the ID assertion
                feature is mostly useful when the asserted
                identities do not exist on the remote server.</p>

                <p>Flags can be</p>

                <p><em class="replaceable"><code>override,[non−]prescriptive,proxy−authz−[non−]critical</code></em></p>

                <p>When the <em class="replaceable"><code>override</code></em> flag is
                used, identity assertion takes place even when the
                database is authorizing for the identity of the
                client, i.e. after binding with the provided
                identity, and thus authenticating it, the proxy
                performs the identity assertion using the
                configured identity and authentication method.</p>

                <p>When the <em class="replaceable"><code>prescriptive</code></em> flag
                is used (the default), operations fail with
                <em class="replaceable"><code>inappropriateAuthentication</code></em>
                for those identities whose assertion is not allowed
                by the <em class="replaceable"><code>idassert−authzFrom</code></em>
                patterns. If the <em class="replaceable"><code>non−prescriptive</code></em>
                flag is used, operations are performed anonymously
                for those identities whose assertion is not allowed
                by the <em class="replaceable"><code>idassert−authzFrom</code></em>
                patterns.</p>

                <p>When the <em class="replaceable"><code>proxy−authz−non−critical</code></em>
                flag is used (the default), the proxyAuthz control
                is not marked as critical, in violation of RFC
                4370. Use of <em class="replaceable"><code>proxy−authz−critical</code></em>
                is recommended.</p>

                <p>The TLS settings default to the same as the main
                slapd TLS settings, except for <em class="replaceable"><code>tls_reqcert</code></em> which
                defaults to "demand".</p>

                <p>The identity associated to this directive is
                also used for privileged operations whenever
                <em class="replaceable"><code>idassert−bind</code></em>
                is defined and <em class="replaceable"><code>acl−bind</code></em> is
                not. See <em class="replaceable"><code>acl−bind</code></em> for
                details.</p>
              </blockquote>
            </div>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>idle−timeout
          &lt;time&gt;</em></span></span></dt>

          <dd>
            <p>This directive causes a cached connection to be
            dropped an recreated after it has been idle for the
            specified time. The value can be specified as</p>

            <p>
            [&lt;d&gt;d][&lt;h&gt;h][&lt;m&gt;m][&lt;s&gt;[s]]</p>

            <p>where &lt;d&gt;, &lt;h&gt;, &lt;m&gt; and &lt;s&gt;
            are respectively treated as days, hours, minutes and
            seconds. If set before any target specification, it
            affects all targets, unless overridden by any
            per-target directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>keepalive
          &lt;idle&gt;:&lt;probes&gt;:&lt;interval&gt;</em></span></span></dt>

          <dd>
            <p>The <em class="replaceable"><code>keepalive</code></em> parameter
            sets the values of <em class="replaceable"><code>idle</code></em>, <em class="replaceable"><code>probes</code></em>, and <em class="replaceable"><code>interval</code></em> used to check
            whether a socket is alive; <em class="replaceable"><code>idle</code></em> is the number of
            seconds a connection needs to remain idle before TCP
            starts sending keepalive probes; <em class="replaceable"><code>probes</code></em> is the maximum
            number of keepalive probes TCP should send before
            dropping the connection; <em class="replaceable"><code>interval</code></em> is interval in
            seconds between individual keepalive probes. Only some
            systems support the customization of these values; the
            <em class="replaceable"><code>keepalive</code></em>
            parameter is ignored otherwise, and system-wide
            settings are used.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>map
          {attribute|objectclass} [&lt;local name&gt;|*]
          {&lt;foreign name&gt;|*}</em></span></span></dt>

          <dd>
            <p>This maps object classes and attributes as in the
            LDAP backend. See <a class="link" href="../htmlman5/slapd-ldap.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd-ldap</span>(5)</span></a>.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>network−timeout
          &lt;time&gt;</em></span></span></dt>

          <dd>
            <p>Sets the network timeout value after which <a class="link" href="../htmlman2/poll.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">poll</span>(2)</span></a>/<a class="link" href="../htmlman2/select.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">select</span>(2)</span></a> following a
            <a class="link" href="../htmlman2/connect.2.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">connect</span>(2)</span></a> returns in
            case of no activity. The value is in seconds, and it
            can be specified as for <em class="replaceable"><code>idle−timeout</code></em>. If
            set before any target specification, it affects all
            targets, unless overridden by any per-target
            directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>nretries
          {forever|never|&lt;nretries&gt;}</em></span></span></dt>

          <dd>
            <p>This directive defines how many times a bind should
            be retried in case of temporary failure in contacting a
            target. If defined before any target specification, it
            applies to all targets (by default, <code class="constant">3</code> times); the global value can be
            overridden by redefinitions inside each target
            specification.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>rewrite* ...</em></span></span></dt>

          <dd>
            <p>The rewrite options are described in the "REWRITING"
            section.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>subtree−{exclude|include}
          &lt;rule&gt;</em></span></span></dt>

          <dd>
            <p>This directive allows to indicate what subtrees are
            actually served by a target. The syntax of the
            supported rules is</p>

            <p><span class="emphasis"><em>&lt;rule&gt;:
            [dn[.&lt;style&gt;]:]&lt;pattern&gt;</em></span></p>

            <p><span class="emphasis"><em>&lt;style&gt;:
            subtree|children|regex</em></span></p>

            <p>When <em class="replaceable"><code>&lt;style&gt;</code></em> is either
            <em class="replaceable"><code>subtree</code></em> or
            <em class="replaceable"><code>children</code></em> the
            <em class="replaceable"><code>&lt;pattern&gt;</code></em> is a DN
            that must be within the naming context served by the
            target. When <em class="replaceable"><code>&lt;style&gt;</code></em> is
            <span class="emphasis"><em>regex</em></span> the
            <em class="replaceable"><code>&lt;pattern&gt;</code></em> is a
            <span class="citerefentry"><span class="refentrytitle">regex</span>(5)</span> pattern. If the
            <em class="replaceable"><code>dn.&lt;style&gt;:</code></em>
            prefix is omitted, <em class="replaceable"><code>dn.subtree:</code></em> is
            implicitly assumed for backward compatibility.</p>

            <p>In the <em class="replaceable"><code>subtree−exclude</code></em>
            form if the <span class="emphasis"><em>request
            DN</em></span> matches at least one rule, the target is
            not considered while fulfilling the request; otherwise,
            the target is considered based on the value of the
            <span class="emphasis"><em>request DN</em></span>. When
            the request is a search, also the <em class="replaceable"><code>scope</code></em> is
            considered.</p>

            <p>In the <em class="replaceable"><code>subtree−include</code></em>
            form if the <span class="emphasis"><em>request
            DN</em></span> matches at least one rule, the target is
            considered while fulfilling the request; otherwise the
            target is ignored.</p>

            <div class="blockquote">
              <blockquote class="blockquote">
                <div class="informalexample">
                  <pre class="programlisting" xml:space="preserve">
    |  match  | exclude |
    +---------+---------+-------------------+
    |    T    |    T    | not candidate     |
    |    F    |    T    | continue checking |
    +---------+---------+-------------------+
    |    T    |    F    | candidate         |
    |    F    |    F    | not candidate     |
    +---------+---------+-------------------+
</pre>
                </div>
              </blockquote>
            </div>

            <div class="blockquote">
              <blockquote class="blockquote">
                <p>There may be multiple occurrences of the
                <em class="replaceable"><code>subtree−exclude</code></em>
                or <em class="replaceable"><code>subtree−include</code></em>
                directive for each of the targets, but they are
                mutually exclusive.</p>
              </blockquote>
            </div>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>suffixmassage &lt;virtual naming
          context&gt; &lt;real naming
          context&gt;</em></span></span></dt>

          <dd>
            <p>All the directives starting with "rewrite" refer to
            the rewrite engine that has been added to slapd. The
            "suffixmassage" directive was introduced in the LDAP
            backend to allow suffix massaging while proxying. It
            has been obsoleted by the rewriting tools. However,
            both for backward compatibility and for ease of
            configuration when simple suffix massage is required,
            it has been preserved. It wraps the basic rewriting
            instructions that perform suffix massaging. See the
            "REWRITING" section for a detailed list of the rewrite
            rules it implies.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>t−f−support
          {NO|yes|discover}</em></span></span></dt>

          <dd>
            <p>enable if the remote server supports absolute
            filters (see <span class="emphasis"><em>RFC
            4526</em></span> for details). If set to <em class="replaceable"><code>discover</code></em>, support is
            detected by reading the remote server's root DSE. If
            set before any target specification, it affects all
            targets, unless overridden by any per-target
            directive.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>timeout
          [&lt;op&gt;=]&lt;val&gt; [...]</em></span></span></dt>

          <dd>
            <p>This directive allows to set per-operation timeouts.
            Operations can be</p>

            <p><span class="emphasis"><em>&lt;op&gt; ::= bind, add,
            delete, modrdn, modify, compare, search</em></span></p>

            <p>The overall duration of the <em class="replaceable"><code>search</code></em> operation is
            controlled either by the <em class="replaceable"><code>timelimit</code></em> parameter or
            by server-side enforced time limits (see <em class="replaceable"><code>timelimit</code></em> and
            <em class="replaceable"><code>limits</code></em> in
            <a class="link" href="../htmlman5/slapd.conf.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd.conf</span>(5)</span></a> for
            details). This <em class="replaceable"><code>timeout</code></em> parameter
            controls how long the target can be irresponsive before
            the operation is aborted. Timeout is meaningless for
            the remaining operations, <em class="replaceable"><code>unbind</code></em> and <em class="replaceable"><code>abandon</code></em>, which do not
            imply any response, while it is not yet implemented in
            currently supported <em class="replaceable"><code>extended</code></em> operations. If
            no operation is specified, the timeout <em class="replaceable"><code>val</code></em> affects all
            supported operations. If specified before any target
            definition, it affects all targets unless overridden by
            per-target directives.</p>

            <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
              <table border="0" summary="Note">
                <tr>
                  <td rowspan="2" align="center" valign="top" width="25" colspan="1"><img alt="[Note]" src="../stylesheet/note.png" /></td>

                  <th align="left" rowspan="1" colspan="1">Note</th>
                </tr>

                <tr>
                  <td align="left" valign="top" rowspan="1" colspan="1">
                    <p>If the timeout is exceeded, the operation is
                    cancelled (according to the <em class="replaceable"><code>cancel</code></em>
                    directive); the protocol does not provide any
                    means to rollback operations, so the client
                    will not be notified about the result of the
                    operation, which may eventually succeeded or
                    not. In case the timeout is exceeded during a
                    bind operation, the connection is destroyed,
                    according to RFC4511.</p>
                  </td>
                </tr>
              </table>
            </div>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>tls
          {[try−]start|[try−]propagate}</em></span></span></dt>

          <dd>
            <p>execute the StartTLS extended operation when the
            connection is initialized; only works if the URI
            directive protocol scheme is not <em class="replaceable"><code>ldaps://</code></em>. <em class="replaceable"><code>propagate</code></em> issues the
            StartTLS operation only if the original connection did.
            The <em class="replaceable"><code>try−</code></em> prefix
            instructs the proxy to continue operations if the
            StartTLS operation failed; its use is highly
            deprecated. If set before any target specification, it
            affects all targets, unless overridden by any
            per-target directive.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect6" name="slapd-meta-5_sect6" shape="rect"> </a>

      <h2>SCENARIOS</h2>

      <p>A powerful (and in some sense dangerous) rewrite engine
      has been added to both the LDAP and Meta backends. While the
      former can gain limited beneficial effects from rewriting
      stuff, the latter can become an amazingly powerful tool.</p>

      <p>Consider a couple of scenarios first.</p>

      <p>1) Two directory servers share two levels of naming
      context; say "dc=a,dc=foo,dc=com" and "dc=b,dc=foo,dc=com".
      Then, an unambiguous Meta database can be configured as:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
database meta
suffix   "<em class="replaceable"><code>dc=foo,dc=com</code></em>"
uri      "ldap://a.foo.com/dc=a,<em class="replaceable"><code>dc=foo,dc=com</code></em>"
uri      "ldap://b.foo.com/dc=b,<em class="replaceable"><code>dc=foo,dc=com</code></em>"
</pre>
          </div>
        </blockquote>
      </div>

      <p>Operations directed to a specific target can be easily
      resolved because there are no ambiguities. The only operation
      that may resolve to multiple targets is a search with base
      "dc=foo,dc=com" and scope at least "one", which results in
      spawning two searches to the targets.</p>

      <p>2a) Two directory servers don't share any portion of
      naming context, but they'd present as a single DIT [Caveat:
      uniqueness of (massaged) entries among the two servers is
      assumed; integrity checks risk to incur in excessive overhead
      and have not been implemented]. Say we have "dc=bar,dc=org"
      and "o=Foo,c=US", and we'd like them to appear as branches of
      "dc=foo,dc=com", say "dc=a,dc=foo,dc=com" and
      "dc=b,dc=foo,dc=com". Then we need to configure our Meta
      backend as:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
database      meta
suffix        "dc=foo,dc=com"

uri           "ldap://a.bar.com/<em class="replaceable"><code>dc=a,dc=foo,dc=com</code></em>"
suffixmassage "<em class="replaceable"><code>dc=a,dc=foo,dc=com</code></em>" "dc=bar,dc=org"

uri           "ldap://b.foo.com/<em class="replaceable"><code>dc=b,dc=foo,dc=com</code></em>"
suffixmassage "<em class="replaceable"><code>dc=b,dc=foo,dc=com</code></em>" "o=Foo,c=US"
</pre>
          </div>
        </blockquote>
      </div>

      <p>Again, operations can be resolved without ambiguity,
      although some rewriting is required. Notice that the virtual
      naming context of each target is a branch of the database's
      naming context; it is rewritten back and forth when
      operations are performed towards the target servers. What
      "back and forth" means will be clarified later.</p>

      <p>When a search with base "dc=foo,dc=com" is attempted, if
      the scope is "base" it fails with "no such object"; in fact,
      the common root of the two targets (prior to massaging) does
      not exist. If the scope is "one", both targets are contacted
      with the base replaced by each target's base; the scope is
      derated to "base". In general, a scope "one" search is
      honored, and the scope is derated, only when the incoming
      base is at most one level lower of a target's naming context
      (prior to massaging).</p>

      <p>Finally, if the scope is "sub" the incoming base is
      replaced by each target's unmassaged naming context, and the
      scope is not altered.</p>

      <p>2b) Consider the above reported scenario with the two
      servers sharing the same naming context:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
database      meta
suffix        "<em class="replaceable"><code>dc=foo,dc=com</code></em>"

uri           "ldap://a.bar.com/<em class="replaceable"><code>dc=foo,dc=com</code></em>"
suffixmassage "<em class="replaceable"><code>dc=foo,dc=com</code></em>" "dc=bar,dc=org"

uri           "ldap://b.foo.com/<em class="replaceable"><code>dc=foo,dc=com</code></em>"
suffixmassage "<em class="replaceable"><code>dc=foo,dc=com</code></em>" "o=Foo,c=US"
</pre>
          </div>
        </blockquote>
      </div>

      <p>All the previous considerations hold, except that now
      there is no way to unambiguously resolve a DN. In this case,
      all the operations that require an unambiguous target
      selection will fail unless the DN is already cached or a
      default target has been set. Practical configurations may
      result as a combination of all the above scenarios.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect7" name="slapd-meta-5_sect7" shape="rect"> </a>

      <h2>ACLs</h2>

      <p>Note on ACLs: at present you may add whatever ACL rule you
      desire to to the Meta (and LDAP) backends. However, the
      meaning of an ACL on a proxy may require some considerations.
      Two philosophies may be considered:</p>

      <p>a) the remote server dictates the permissions; the proxy
      simply passes back what it gets from the remote server.</p>

      <p>b) the remote server unveils "everything"; the proxy is
      responsible for protecting data from unauthorized access.</p>

      <p>Of course the latter sounds unreasonable, but it is not.
      It is possible to imagine scenarios in which a remote host
      discloses data that can be considered "public" inside an
      intranet, and a proxy that connects it to the internet may
      impose additional constraints. To this purpose, the proxy
      should be able to comply with all the ACL matching criteria
      that the server supports. This has been achieved with regard
      to all the criteria supported by slapd except a special
      subtle case (please file an ITS if you can find other
      exceptions: &lt;<a class="literalurl" href="http://www.openldap.org/its/" target="_top" shape="rect">http://www.openldap.org/its/</a>&gt;). The rule</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
access to dn="&lt;dn&gt;" attrs=&lt;attr&gt;
       by dnattr=&lt;dnattr&gt; read
       by * none
</pre>
          </div>
        </blockquote>
      </div>

      <p>cannot be matched iff the attribute that is being
      requested, &lt;attr&gt;, is NOT &lt;dnattr&gt;, and the
      attribute that determines membership, &lt;dnattr&gt;, has not
      been requested (e.g. in a search)</p>

      <p>In fact this ACL is resolved by slapd using the portion of
      entry it retrieved from the remote server without requiring
      any further intervention of the backend, so, if the
      &lt;dnattr&gt; attribute has not been fetched, the match
      cannot be assessed because the attribute is not present, not
      because no value matches the requirement!</p>

      <p>Note on ACLs and attribute mapping: ACLs are applied to
      the mapped attributes; for instance, if the attribute locally
      known as "foo" is mapped to "bar" on a remote server, then
      local ACLs apply to attribute "foo" and are totally unaware
      of its remote name. The remote server will check permissions
      for "bar", and the local server will possibly enforce
      additional restrictions to "foo".</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect8" name="slapd-meta-5_sect8" shape="rect"> </a>

      <h2>REWRITING</h2>

      <p>A string is rewritten according to a set of rules, called
      a `rewrite context'. The rules are based on POSIX
      (''extended'') regular expressions (regex) with substring
      matching; basic variable substitution and map resolution of
      substrings is allowed by specific mechanisms detailed in the
      following. The behavior of pattern matching/substitution can
      be altered by a set of flags.</p>

      <p>The underlying concept is to build a lightweight rewrite
      module for the slapd server (initially dedicated to the LDAP
      backend).</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect9" name="slapd-meta-5_sect9" shape="rect"> </a>

      <h2>Passes</h2>

      <p>An incoming string is matched against a set of rules.
      Rules are made of a regex match pattern, a substitution
      pattern and a set of actions, described by a set of flags. In
      case of match a string rewriting is performed according to
      the substitution pattern that allows to refer to substrings
      matched in the incoming string. The actions, if any, are
      finally performed. The substitution pattern allows map
      resolution of substrings. A map is a generic object that maps
      a substitution pattern to a value. The flags are divided in
      "Pattern matching Flags" and "Action Flags"; the former alter
      the regex match pattern behavior while the latter alter the
      action that is taken after substitution.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect10" name="slapd-meta-5_sect10" shape="rect"> </a>

      <h2>Pattern Matching Flags</h2>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><em class="replaceable"><code>`C'</code></em></span></dt>

          <dd>
            <p>honors case in matching (default is case
            insensitive)</p>
          </dd>

          <dt><span class="term"><em class="replaceable"><code>`R'</code></em></span></dt>

          <dd>
            <p>use POSIX ''basic'' regular expressions (default is
            ''extended'')</p>
          </dd>

          <dt><span class="term">`M{n}'</span></dt>

          <dd>
            <p>allow no more than <code class="literal">n</code>
            recursive passes for a specific rule; does not alter
            the max total count of passes, so it can only enforce a
            stricter limit for a specific rule.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect11" name="slapd-meta-5_sect11" shape="rect"> </a>

      <h2>Action Flags</h2>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term">`:'</span></dt>

          <dd>
            <p>apply the rule once only (default is recursive)</p>
          </dd>

          <dt><span class="term"><em class="replaceable"><code>`@'</code></em></span></dt>

          <dd>
            <p>stop applying rules in case of match; the current
            rule is still applied recursively; combine with `:' to
            apply the current rule only once and then stop.</p>
          </dd>

          <dt><span class="term"><em class="replaceable"><code>`#'</code></em></span></dt>

          <dd>
            <p>stop current operation if the rule matches, and
            issue an `unwilling to perform' error.</p>
          </dd>

          <dt><span class="term">`G{n}'</span></dt>

          <dd>
            <p>jump <code class="literal">n</code> rules back and
            forth (watch for loops!). Note that `G{1}' is implicit
            in every rule.</p>
          </dd>

          <dt><span class="term"><em class="replaceable"><code>`I'</code></em></span></dt>

          <dd>
            <p>ignores errors in rule; this means, in case of
            error, e.g. issued by a map, the error is treated as a
            missed match. The `unwilling to perform' is not
            overridden.</p>
          </dd>

          <dt><span class="term">`U{n}'</span></dt>

          <dd>
            <p>uses <code class="literal">n</code> as return code
            if the rule matches; the flag does not alter the
            recursive behavior of the rule, so, to have it
            performed only once, it must be used in combination
            with `:', e.g. <em class="replaceable"><code>`:U{16}'</code></em> returns the
            value `16' after exactly one execution of the rule, if
            the pattern matches. As a consequence, its behavior is
            equivalent to `@', with the return code set to
            <code class="literal">n</code>; or, in other words, `@'
            is equivalent to `U{0}'. By convention, the freely
            available codes are above 16 included; the others are
            reserved.</p>
          </dd>
        </dl>
      </div>

      <p>The ordering of the flags can be significant. For
      instance: `IG{2}' means ignore errors and jump two lines
      ahead both in case of match and in case of error, while
      `G{2}I' means ignore errors, but jump two lines ahead only in
      case of match.</p>

      <p>More flags (mainly Action Flags) will be added as
      needed.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect12" name="slapd-meta-5_sect12" shape="rect"> </a>

      <h2>Pattern matching:</h2>

      <p>See <a class="link" href="../htmlman7/regex.7.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">regex</span>(7)</span></a> and/or
      <span class="citerefentry"><span class="refentrytitle">re_format</span>(7)</span>.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect13" name="slapd-meta-5_sect13" shape="rect"> </a>

      <h2>Substitution Pattern Syntax:</h2>

      <p>Everything starting with `%' requires substitution;</p>

      <p>the only obvious exception is `%%', which is left as
      is;</p>

      <p>the basic substitution is `%d', where `d' is a digit; 0
      means the whole string, while 1-9 is a submatch;</p>

      <p>a `%' followed by a `{' invokes an advanced substitution.
      The pattern is:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <p>`%' `{' [ &lt;op&gt; ] &lt;name&gt; `('
          &lt;substitution&gt; `)' `}'</p>
        </blockquote>
      </div>

      <p>where &lt;name&gt; must be a legal name for the map,
      i.e.</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
&lt;name&gt; ::= [a-z][a-z0-9]* (case insensitive)
&lt;op&gt; ::= `&gt;' `|' `&amp;' `&amp;&amp;' `*' `**' `$'
</pre>
          </div>
        </blockquote>
      </div>

      <p>and &lt;substitution&gt; must be a legal substitution
      pattern, with no limits on the nesting level.</p>

      <p>The operators are:</p>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term">&gt;</span></dt>

          <dd>
            <p>sub context invocation; &lt;name&gt; must be a
            legal, already defined rewrite context name</p>
          </dd>

          <dt><span class="term"><code class="literal">|</code></span></dt>

          <dd>
            <p>external command invocation; &lt;name&gt; must refer
            to a legal, already defined command name (NOT
            IMPL.)</p>
          </dd>

          <dt><span class="term">&amp;</span></dt>

          <dd>
            <p>variable assignment; &lt;name&gt; defines a variable
            in the running operation structure which can be
            dereferenced later; operator <em class="replaceable"><code>&amp;</code></em> assigns a
            variable in the rewrite context scope; operator
            <em class="replaceable"><code>&amp;&amp;</code></em>
            assigns a variable that scopes the entire session, e.g.
            its value can be dereferenced later by other rewrite
            contexts</p>

            <p>variable dereferencing; &lt;name&gt; must refer to a
            variable that is defined and assigned for the running
            operation; operator <code class="literal">*</code>
            dereferences a variable scoping the rewrite context;
            operator <em class="replaceable"><code>**</code></em>
            dereferences a variable scoping the whole session, e.g.
            the value is passed across rewrite contexts</p>
          </dd>

          <dt><span class="term"><code class="literal">$</code></span></dt>

          <dd>
            <p>parameter dereferencing; &lt;name&gt; must refer to
            an existing parameter; the idea is to make some
            run-time parameters set by the system available to the
            rewrite engine, as the client host name, the bind DN if
            any, constant parameters initialized at config time,
            and so on; no parameter is currently set by either
            <em class="replaceable"><code>back−ldap</code></em> or
            <em class="replaceable"><code>back−meta</code></em>, but
            constant parameters can be defined in the configuration
            file by using the <em class="replaceable"><code>rewriteParam</code></em>
            directive.</p>
          </dd>
        </dl>
      </div>

      <p>Substitution escaping has been delegated to the `%'
      symbol, which is used instead of `\' in string substitution
      patterns because `\' is already escaped by slapd's low level
      parsing routines; as a consequence, regex escaping requires
      two `\' symbols, e.g. `<em class="replaceable"><code>.*\.foo\.bar</code></em>' must be written
      as `<em class="replaceable"><code>.*\\.foo\\.bar</code></em>'.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect14" name="slapd-meta-5_sect14" shape="rect"> </a>

      <h2>Rewrite context:</h2>

      <p>A rewrite context is a set of rules which are applied in
      sequence. The basic idea is to have an application initialize
      a rewrite engine (think of Apache's mod_rewrite ...) with a
      set of rewrite contexts; when string rewriting is required,
      one invokes the appropriate rewrite context with the input
      string and obtains the newly rewritten one if no errors
      occur.</p>

      <p>Each basic server operation is associated to a rewrite
      context; they are divided in two main groups: client
      −&gt; server and server −&gt; client
      rewriting.</p>

      <p>client −&gt; server:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
(default)            if defined and no specific context 
                     is available
bindDN               bind
searchBase           search
searchFilter         search
searchFilterAttrDN   search
compareDN            compare
compareAttrDN        compare AVA
addDN                add
addAttrDN            add AVA
modifyDN             modify
modifyAttrDN         modify AVA
modrDN               modrdn
newSuperiorDN        modrdn
deleteDN             delete
exopPasswdDN         password modify extended operation DN if proxy
</pre>
          </div>
        </blockquote>
      </div>

      <p>server −&gt; client:</p>

      <div class="blockquote">
        <blockquote class="blockquote">
          <div class="informalexample">
            <pre class="programlisting" xml:space="preserve">
searchResult         search (only if defined; no default;
                     acts on DN and DN-syntax attributes 
                     of search results)
searchAttrDN         search AVA
matchedDN            all ops (only if applicable)
</pre>
          </div>
        </blockquote>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect15" name="slapd-meta-5_sect15" shape="rect"> </a>

      <h2>Basic configuration syntax</h2>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><span class="emphasis"><em>rewriteEngine { on | off
          }</em></span></span></dt>

          <dd>
            <p>If `on', the requested rewriting is performed; if
            `off', no rewriting takes place (an easy way to stop
            rewriting without altering too much the configuration
            file).</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>rewriteContext &lt;context name&gt; [
          alias &lt;aliased context name&gt;
          ]</em></span></span></dt>

          <dd>
            <p>&lt;Context name&gt; is the name that identifies the
            context, i.e. the name used by the application to refer
            to the set of rules it contains. It is used also to
            reference sub contexts in string rewriting. A context
            may alias another one. In this case the alias context
            contains no rule, and any reference to it will result
            in accessing the aliased one.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>rewriteRule &lt;regex match pattern&gt;
          &lt;substitution pattern&gt; [ &lt;flags&gt;
          ]</em></span></span></dt>

          <dd>
            <p>Determines how a string can be rewritten if a
            pattern is matched. Examples are reported below.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect16" name="slapd-meta-5_sect16" shape="rect"> </a>

      <h2>Additional configuration syntax:</h2>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><span class="emphasis"><em>rewriteMap &lt;map type&gt; &lt;map
          name&gt; [ &lt;map attrs&gt; ]</em></span></span></dt>

          <dd>
            <p>Allows to define a map that transforms substring
            rewriting into something else. The map is referenced
            inside the substitution pattern of a rule.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>rewriteParam &lt;param name&gt; &lt;param
          value&gt;</em></span></span></dt>

          <dd>
            <p>Sets a value with global scope, that can be
            dereferenced by the command `%{$paramName}'.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>rewriteMaxPasses &lt;number of passes&gt;
          [&lt;number of passes per
          rule&gt;]</em></span></span></dt>

          <dd>
            <p>Sets the maximum number of total rewriting passes
            that can be performed in a single rewrite operation (to
            avoid loops). A safe default is set to 100; note that
            reaching this limit is still treated as a success;
            recursive invocation of rules is simply interrupted.
            The count applies to the rewriting operation as a
            whole, not to any single rule; an optional per-rule
            limit can be set. This limit is overridden by setting
            specific per-rule limits with the `M{n}' flag.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect17" name="slapd-meta-5_sect17" shape="rect"> </a>

      <h2>Configuration examples:</h2>

      <div class="informalexample">
        <pre class="programlisting" xml:space="preserve">
# set to `off' to disable rewriting
rewriteEngine on

# the rules the "suffixmassage" directive implies
rewriteEngine on
# all dataflow from client to server referring to DNs
rewriteContext default
rewriteRule "(.*)&lt;virtualnamingcontext&gt;$" "%1&lt;realnamingcontext&gt;" ":"
# empty filter rule
rewriteContext searchFilter
# all dataflow from server to client
rewriteContext searchResult
rewriteRule "(.*)&lt;realnamingcontext&gt;$" "%1&lt;virtualnamingcontext&gt;" ":"
rewriteContext searchAttrDN alias searchResult
rewriteContext matchedDN alias searchResult

# Everything defined here goes into the `default' context.
# This rule changes the naming context of anything sent
# to `dc=home,dc=net' to `dc=OpenLDAP, dc=org'

rewriteRule "(.*)dc=home,[ ]?dc=net"
            "%1dc=OpenLDAP, dc=org"  ":"

# since a pretty/normalized DN does not include spaces
# after rdn separators, e.g. `,', this rule suffices:

rewriteRule "(.*)dc=home,dc=net"
            "%1dc=OpenLDAP,dc=org"  ":"

# Start a new context (ends input of the previous one).
# This rule adds blanks between DN parts if not present.
rewriteContext  addBlanks
rewriteRule     "(.*),([^ ].*)" "%1, %2"

# This one eats blanks
rewriteContext  eatBlanks
rewriteRule     "(.*),[ ](.*)" "%1,%2"

# Here control goes back to the default rewrite
# context; rules are appended to the existing ones.
# anything that gets here is piped into rule `addBlanks'
rewriteContext  default
rewriteRule     ".*" "%{&gt;addBlanks(%0)}" ":"

# Rewrite the search base according to `default' rules.
rewriteContext  searchBase alias default

# Search results with OpenLDAP DN are rewritten back with
# `dc=home,dc=net' naming context, with spaces eaten.
rewriteContext  searchResult
rewriteRule     "(.*[^ ]?)[ ]?dc=OpenLDAP,[ ]?dc=org"
                "%{&gt;eatBlanks(%1)}dc=home,dc=net"    ":"

# Bind with email instead of full DN: we first need
# an ldap map that turns attributes into a DN (the
# argument used when invoking the map is appended to 
# the URI and acts as the filter portion)
rewriteMap ldap attr2dn "ldap://host/dc=my,dc=org?dn?sub"

# Then we need to detect DN made up of a single email,
# e.g. `mail=someone@example.com'; note that the rule
# in case of match stops rewriting; in case of error,
# it is ignored.  In case we are mapping virtual
# to real naming contexts, we also need to rewrite
# regular DNs, because the definition of a bindDn
# rewrite context overrides the default definition.
rewriteContext bindDN
rewriteRule "^mail=[^,]+@[^,]+$" "%{attr2dn(%0)}" ":@I"

# This is a rather sophisticated example. It massages a
# search filter in case who performs the search has
# administrative privileges.  First we need to keep
# track of the bind DN of the incoming request, which is
# stored in a variable called `binddn' with session scope,
# and left in place to allow regular binding:
rewriteContext  bindDN
rewriteRule     ".+" "%{&amp;&amp;binddn(%0)}%0" ":"

# A search filter containing `uid=' is rewritten only
# if an appropriate DN is bound.
# To do this, in the first rule the bound DN is
# dereferenced, while the filter is decomposed in a
# prefix, in the value of the `uid=&lt;arg&gt;' AVA, and 
# in a suffix. A tag `&lt;&gt;' is appended to the DN. 
# If the DN refers to an entry in the `ou=admin' subtree, 
# the filter is rewritten OR-ing the `uid=&lt;arg&gt;' with
# `cn=&lt;arg&gt;'; otherwise it is left as is. This could be
# useful, for instance, to allow apache's auth_ldap-1.4
# module to authenticate users with both `uid' and
# `cn', but only if the request comes from a possible
# `cn=Web auth,ou=admin,dc=home,dc=net' user.
rewriteContext searchFilter
rewriteRule "(.*\\()uid=([a-z0-9_]+)(\\).*)"
  "%{**binddn}&lt;&gt;%{&amp;prefix(%1)}%{&amp;arg(%2)}%{&amp;suffix(%3)}"
  ":I"
rewriteRule "[^,]+,ou=admin,dc=home,dc=net"
  "%{*prefix}|(uid=%{*arg})(cn=%{*arg})%{*suffix}" ":@I"
rewriteRule ".*&lt;&gt;" "%{*prefix}uid=%{*arg}%{*suffix}" ":"

# This example shows how to strip unwanted DN-valued
# attribute values from a search result; the first rule
# matches DN values below "ou=People,dc=example,dc=com";
# in case of match the rewriting exits successfully.
# The second rule matches everything else and causes
# the value to be rejected.
rewriteContext searchResult
rewriteRule ".*,ou=People,dc=example,dc=com" "%0" ":@"
rewriteRule ".*" "" "#"
</pre>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect18" name="slapd-meta-5_sect18" shape="rect"> </a>

      <h2>LDAP Proxy resolution (a possible evolution of
      slapd−ldap(5)):</h2>

      <p>In case the rewritten DN is an LDAP URI, the operation is
      initiated towards the host[:port] indicated in the uri, if it
      does not refer to the local server. E.g.:</p>

      <div class="informalexample">
        <pre class="programlisting" xml:space="preserve">
  rewriteRule '^cn=root,.*' '%0'                     'G{3}'
  rewriteRule '^cn=[a-l].*' 'ldap://ldap1.my.org/%0' ':@'
  rewriteRule '^cn=[m-z].*' 'ldap://ldap2.my.org/%0' ':@'
  rewriteRule '.*'          'ldap://ldap3.my.org/%0' ':@'
</pre>
      </div>

      <p>(Rule 1 is simply there to illustrate the `G{n}' action;
      it could have been written:</p>

      <div class="informalexample">
        <pre class="programlisting" xml:space="preserve">
  rewriteRule '^cn=root,.*' 'ldap://ldap3.my.org/%0' ':@'
</pre>
      </div>

      <p>with the advantage of saving one rewrite pass ...)</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect19" name="slapd-meta-5_sect19" shape="rect"> </a>

      <h2>ACCESS CONTROL</h2>

      <p>The <em class="replaceable"><code>meta</code></em> backend
      does not honor all ACL semantics as described in <a class="link" href="../htmlman5/slapd.access.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd.access</span>(5)</span></a>. In
      general, access checking is delegated to the remote
      server(s). Only <span class="emphasis"><em>read
      (=r)</em></span> access to the <em class="replaceable"><code>entry</code></em> pseudo-attribute and to
      the other attribute values of the entries returned by the
      <em class="replaceable"><code>search</code></em> operation is
      honored, which is performed by the frontend.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect20" name="slapd-meta-5_sect20" shape="rect"> </a>

      <h2>PROXY CACHE OVERLAY</h2>

      <p>The proxy cache overlay allows caching of LDAP search
      requests (queries) in a local database. See <a class="link" href="../htmlman5/slapo-pcache.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapo-pcache</span>(5)</span></a> for
      details.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect21" name="slapd-meta-5_sect21" shape="rect"> </a>

      <h2>DEPRECATED STATEMENTS</h2>

      <p>The following statements have been deprecated and should
      no longer be used.</p>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term"><span class="emphasis"><em>pseudorootdn &lt;substitute DN in case of
          rootdn bind&gt;</em></span></span></dt>

          <dd>
            <p>Use <em class="replaceable"><code>idassert−bind</code></em>
            instead.</p>
          </dd>

          <dt><span class="term"><span class="emphasis"><em>pseudorootpw &lt;substitute password in
          case of rootdn bind&gt;</em></span></span></dt>

          <dd>
            <p>Use <em class="replaceable"><code>idassert−bind</code></em>
            instead.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect22" name="slapd-meta-5_sect22" shape="rect"> </a>

      <h2>FILES</h2>

      <div class="variablelist">
        <dl class="variablelist">
          <dt><span class="term">ETCDIR/slapd.conf</span></dt>

          <dd>
            <p>default slapd configuration file</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect23" name="slapd-meta-5_sect23" shape="rect"> </a>

      <h2>SEE ALSO</h2>

      <p><a class="link" href="../htmlman5/slapd.conf.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd.conf</span>(5)</span></a>, <a class="link" href="../htmlman5/slapd-ldap.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd-ldap</span>(5)</span></a>, <a class="link" href="../htmlman5/slapo-pcache.5.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapo-pcache</span>(5)</span></a>, <a class="link" href="../htmlman8/slapd.8.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">slapd</span>(8)</span></a>, <a class="link" href="../htmlman7/regex.7.html" target="_top" shape="rect"><span class="citerefentry"><span class="refentrytitle">regex</span>(7)</span></a>, <span class="citerefentry"><span class="refentrytitle">re_format</span>(7)</span>.</p>
    </div>

    <div class="refsect1">
      <a id="slapd-meta-5_sect24" name="slapd-meta-5_sect24" shape="rect"> </a>

      <h2>AUTHOR</h2>

      <p>Pierangelo Masarati, based on back-ldap by Howard Chu</p>

      <div class="license">
        <table style="border-collapse: collapse;">
          <colgroup span="1">
            <col span="1" />
          </colgroup>

          <tbody>
            <tr>
              <td style="" rowspan="1" colspan="1">
                <div class="literallayout">
                  <br />
                  See the following documents: <a class="ulink" href="../openldap-COPYRIGHT.html" target="_top" shape="rect">COPYRIGHT</a>, <a class="ulink" href="../openldap-LICENSE.html" target="_top" shape="rect">LICENSE</a><br />
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
